import{j as useTexts,a3 as deleteFile,q as useToast,aa as getFolderList,aG as moveFiles,a9 as __unplugin_components_1,$ as __unplugin_components_0,_ as _export_sfc}from"./index-ae9c3219.js";import{r as ref,a as reactive,c as computed,d as defineComponent,w as watch,I as createElementBlock,f as createVNode,L as withCtx,u as unref,i as isRef,F as Fragment,E as resolveComponent,G as resolveDirective,z as openBlock,M as renderList,R as normalizeClass,a0 as createBaseVNode,K as createCommentVNode,H as withDirectives,A as createBlock,a5 as withModifiers,a1 as toDisplayString,ab as createTextVNode}from"./vue-vendor-31320f47.js";import{l as lo}from"./draggable-5c726607.js";import{s as showConfirm}from"./dialog-751d4bcf.js";function useFileContextMenu(options={}){const showContextMenu=ref(!1),contextMenuPosition=reactive({x:0,y:0}),selectedImage=ref(null),toast=useToast(),{$t}=useTexts(),buildFolderMenuItem=folder=>({key:`folder-${folder.id}`,label:folder.name,icon:"fas fa-folder",onClick:async()=>{if(!selectedImage.value){toast.error($t("folders.fileContextMenu.toast.noFileSelected"));return}const{id}=selectedImage.value;try{await moveFiles([id],folder.id),toast.success($t("folders.fileContextMenu.toast.moveToFolderSuccess",{name:folder.name})),options.onImageMoved?.(id,folder.id)}catch{toast.error($t("folders.fileContextMenu.toast.moveFailed"))}},hasAsyncChildren:folder.has_children,loadChildren:folder.has_children?async()=>{try{const result=await getFolderList(folder.id);return result.success&&result.data?result.data.map(buildFolderMenuItem):[]}catch{throw new Error($t("folders.fileContextMenu.toast.loadSubfoldersFailed"))}}:void 0}),loadRootFolders=async()=>{try{const result=await getFolderList();if(result.success&&result.data){const folderItems=result.data.map(buildFolderMenuItem);return[{key:"root-folder",label:$t("folders.fileContextMenu.menu.root"),icon:"fas fa-home",onClick:async()=>{if(!selectedImage.value){toast.error($t("folders.fileContextMenu.toast.noFileSelected"));return}const{id}=selectedImage.value;try{await moveFiles([id],void 0),toast.success($t("folders.fileContextMenu.toast.moveToRootSuccess")),options.onImageMoved?.(id,void 0)}catch{toast.error($t("folders.fileContextMenu.toast.moveFailed"))}}},...folderItems]}return[]}catch{throw new Error($t("folders.fileContextMenu.toast.loadFoldersFailed"))}},contextMenuItems=computed(()=>[{key:"preview",label:$t("folders.fileContextMenu.menu.preview"),icon:"fas fa-eye",onClick:()=>{selectedImage.value&&options.onPreview?.(selectedImage.value)}},{key:"open-new",label:$t("folders.fileContextMenu.menu.openNew"),icon:"fas fa-external-link-alt",onClick:()=>{if(!selectedImage.value)return;const url=selectedImage.value.full_url||selectedImage.value.url||"";if(!url){toast.error($t("folders.fileContextMenu.toast.noValidImageLink"));return}window.open(url,"_blank")}},{key:"divider-preview-copy",label:"",divided:!0},{key:"copy-link",label:$t("folders.fileContextMenu.menu.copyLink"),icon:"fas fa-link",children:[{key:"copy-thumb",label:$t("folders.fileContextMenu.menu.copyThumb"),icon:"fas fa-image",onClick:async()=>{if(!selectedImage.value)return;const url=selectedImage.value.full_thumb_url||selectedImage.value.thumb_url||"";if(!url){toast.error($t("folders.fileContextMenu.toast.noThumbLink"));return}try{await navigator.clipboard.writeText(url),toast.success($t("folders.fileContextMenu.toast.thumbLinkCopied"))}catch{toast.error($t("folders.fileContextMenu.toast.copyFailed"))}}},{key:"copy-original",label:$t("folders.fileContextMenu.menu.copyOriginal"),icon:"fas fa-photo-film",onClick:async()=>{if(!selectedImage.value)return;const url=selectedImage.value.full_url||selectedImage.value.url||"";if(!url){toast.error($t("folders.fileContextMenu.toast.noOriginalLink"));return}try{await navigator.clipboard.writeText(url),toast.success($t("folders.fileContextMenu.toast.originalLinkCopied"))}catch{toast.error($t("folders.fileContextMenu.toast.copyFailed"))}}},{key:"copy-short",label:$t("folders.fileContextMenu.menu.copyShort"),icon:"fas fa-link",onClick:async()=>{if(!selectedImage.value)return;const url=selectedImage.value.short_url||"";if(!url){toast.error($t("folders.fileContextMenu.toast.noShortLink"));return}try{await navigator.clipboard.writeText(url),toast.success($t("folders.fileContextMenu.toast.shortLinkCopied"))}catch{toast.error($t("folders.fileContextMenu.toast.copyFailed"))}}},{key:"copy-markdown",label:$t("folders.fileContextMenu.menu.copyMarkdown"),icon:"fab fa-markdown",onClick:async()=>{if(!selectedImage.value)return;const url=selectedImage.value.full_url||selectedImage.value.url||"",name=selectedImage.value.display_name||selectedImage.value.name||"";if(!url){toast.error($t("folders.fileContextMenu.toast.noOriginalLink"));return}try{const markdownText=`![${name}](${url})`;await navigator.clipboard.writeText(markdownText),toast.success($t("folders.fileContextMenu.toast.markdownLinkCopied"))}catch{toast.error($t("folders.fileContextMenu.toast.copyFailed"))}}},{key:"copy-html",label:$t("folders.fileContextMenu.menu.copyHtml"),icon:"fab fa-html5",onClick:async()=>{if(!selectedImage.value)return;const url=selectedImage.value.full_url||selectedImage.value.url||"",name=selectedImage.value.display_name||selectedImage.value.name||"";if(!url){toast.error($t("folders.fileContextMenu.toast.noOriginalLink"));return}try{const htmlTag=`<img src="${url}" alt="${name}" />`;await navigator.clipboard.writeText(htmlTag),toast.success($t("folders.fileContextMenu.toast.htmlLinkCopied"))}catch{toast.error($t("folders.fileContextMenu.toast.copyFailed"))}}}]},{key:"divider-after-copy",label:"",divided:!0},{key:"download",label:$t("folders.fileContextMenu.menu.download"),icon:"fas fa-download",onClick:()=>{if(!selectedImage.value)return;if(options.onDownload){options.onDownload(selectedImage.value);return}const a=document.createElement("a");a.href=selectedImage.value.full_url||selectedImage.value.full_thumb_url||"",a.download=selectedImage.value.display_name||selectedImage.value.name||"download",a.target="_blank",document.body.appendChild(a),a.click(),document.body.removeChild(a)}},{key:"move-to",label:$t("folders.fileContextMenu.menu.moveTo"),icon:"fas fa-arrows-alt",hasAsyncChildren:!0,loadChildren:loadRootFolders},{key:"divider-after-move",label:"",divided:!0},{key:"delete",label:$t("folders.fileContextMenu.menu.delete"),icon:"fas fa-trash",danger:!0,onClick:async()=>{if(!selectedImage.value)return;if(options.onDelete){options.onDelete(selectedImage.value);return}const name=selectedImage.value.display_name||selectedImage.value.name||$t("common.file");if(showConfirm($t("folders.fileContextMenu.confirm.deleteFile",{name})))try{const{id}=selectedImage.value;await deleteFile(id),toast.success($t("folders.fileContextMenu.toast.fileDeleted")),options.onImageDeleted?.(id)}catch{toast.error($t("folders.fileContextMenu.toast.deleteFailed"))}}}]);return{showContextMenu,contextMenuPosition,contextMenuItems,selectedImage,showImageContextMenu:(event,image)=>{event.preventDefault(),event.stopPropagation(),selectedImage.value=image,contextMenuPosition.x=event.clientX,contextMenuPosition.y=event.clientY,showContextMenu.value=!0},hideContextMenu:()=>{showContextMenu.value=!1,selectedImage.value=null}}}const _hoisted_1=["onClick","onContextmenu"],_hoisted_2={key:0,class:"image-selected-indicator selectable-check"},_hoisted_3={class:"image-thumbnail"},_hoisted_4={key:3,class:"image-hover-overlay"},_hoisted_5={class:"hover-actions"},_hoisted_6=["title","onClick"],_hoisted_7=["title","onClick"],_hoisted_8=["title","onClick"],_hoisted_9=["title","onClick"],_hoisted_10={class:"image-info"},_hoisted_11=["title"],_hoisted_12={class:"image-meta"},_hoisted_13=["title"],_hoisted_14=["title"],_sfc_main=defineComponent({name:"FilesGridView",__name:"FilesGridView",props:{images:{},selectMode:{type:Boolean},batchMode:{type:Boolean},isImageSelected:{type:Function},isBatchImageSelected:{type:Function},preview:{type:Boolean}},emits:["preview-image","view-details","copy-link","download-image","delete-image","toggle-image-visibility","toggle-image-select","toggle-batch-image-select","image-drag-start","image-drag-end","image-moved","image-deleted"],setup(__props,{emit:__emit}){const props=__props,emit=__emit,imageLoadingStates=ref({}),mutableImages=ref([...props.images]);watch(()=>props.images,newImages=>{mutableImages.value=[...newImages]},{deep:!0});const handleImageClick=image=>{props.selectMode&&!props.preview?emit("toggle-image-select",image):props.batchMode&&!props.preview?emit("toggle-batch-image-select",image):emit("preview-image",image)},{showContextMenu,contextMenuPosition,contextMenuItems,showImageContextMenu,hideContextMenu}=useFileContextMenu({onImageMoved:(fileId,targetFolderId)=>{emit("image-moved",fileId,targetFolderId)},onImageDeleted:fileId=>{emit("image-deleted",fileId)},onPreview:image=>emit("preview-image",image),onCopyLink:image=>emit("copy-link",image),onDownload:image=>emit("download-image",image),onDelete:image=>emit("delete-image",image)}),getImageUrl=(url,_accessLevel)=>url,formatFileSize=size=>size<1024?`${size} B`:size<1024*1024?`${(size/1024).toFixed(1)} KB`:`${(size/(1024*1024)).toFixed(1)} MB`;return(_ctx,_cache)=>{const _component_CyberFile=resolveComponent("CyberFile"),_component_CyberBackground=resolveComponent("CyberBackground"),_component_CyberAccessLevelToggle=resolveComponent("CyberAccessLevelToggle"),_component_cyber_file_expiry_tag=resolveComponent("cyber-file-expiry-tag"),_component_DuplicateBadge=__unplugin_components_0,_component_CyberContextMenu=__unplugin_components_1,_directive_loading=resolveDirective("loading");return openBlock(),createElementBlock(Fragment,null,[createVNode(unref(lo),{modelValue:mutableImages.value,"onUpdate:modelValue":_cache[0]||(_cache[0]=$event=>mutableImages.value=$event),animation:"150","ghost-class":"image-ghost","chosen-class":"image-chosen","drag-class":"image-drag",disabled:__props.selectMode||__props.batchMode||__props.preview,class:"images-grid",onStart:_cache[1]||(_cache[1]=$event=>_ctx.$emit("image-drag-start")),onEnd:_cache[2]||(_cache[2]=event=>_ctx.$emit("image-drag-end",{event,sortedFiles:mutableImages.value}))},{default:withCtx(()=>[(openBlock(!0),createElementBlock(Fragment,null,renderList(mutableImages.value,image=>(openBlock(),createElementBlock("div",{key:image.id,class:normalizeClass(["image-item selectable-item",{selected:__props.selectMode&&__props.isImageSelected?.(image)||__props.batchMode&&__props.isBatchImageSelected?.(image),"is-selected":__props.selectMode&&__props.isImageSelected?.(image)||__props.batchMode&&__props.isBatchImageSelected?.(image),selectable:__props.selectMode||__props.batchMode}]),onClick:$event=>handleImageClick(image),onContextmenu:$event=>__props.preview?void 0:unref(showImageContextMenu)($event,image)},[__props.selectMode&&__props.isImageSelected?.(image)||__props.batchMode&&__props.isBatchImageSelected?.(image)?(openBlock(),createElementBlock("div",_hoisted_2,[..._cache[4]||(_cache[4]=[createBaseVNode("i",{class:"fas fa-check"},null,-1)])])):createCommentVNode("",!0),withDirectives((openBlock(),createElementBlock("div",_hoisted_3,[createVNode(_component_CyberBackground,{pattern:"cyber"},{default:withCtx(()=>[createVNode(_component_CyberFile,{src:getImageUrl(image.full_thumb_url,image.access_level),alt:image.display_name,"fit-mode":"contain","maintain-aspect-ratio":!0,"retry-count":2,"is-nsfw":image.is_nsfw,onLoading:$event=>imageLoadingStates.value[image.id]=$event},null,8,["src","alt","is-nsfw","onLoading"])]),_:2},1024),!__props.preview&&!__props.selectMode&&!__props.batchMode?(openBlock(),createBlock(_component_CyberAccessLevelToggle,{key:0,"access-level":image.access_level,type:"image",size:"medium",onToggle:$event=>_ctx.$emit("toggle-image-visibility",image)},null,8,["access-level","onToggle"])):createCommentVNode("",!0),image.is_time_limited?(openBlock(),createBlock(_component_cyber_file_expiry_tag,{key:1,"expires-at":image.expires_at,"storage-duration":image.storage_duration,"is-time-limited":image.is_time_limited,position:"top-left",mode:"both","show-icon":!0},null,8,["expires-at","storage-duration","is-time-limited"])):createCommentVNode("",!0),image.is_duplicate?(openBlock(),createBlock(_component_DuplicateBadge,{key:2,position:"top-left",icon:"fas fa-clone",text:_ctx.$t("folders.fileGrid.badge.duplicate")},null,8,["text"])):createCommentVNode("",!0),!__props.selectMode&&!__props.batchMode?(openBlock(),createElementBlock("div",_hoisted_4,[createBaseVNode("div",_hoisted_5,[image.ai_info?(openBlock(),createElementBlock("button",{key:0,class:"action-btn info-btn",title:_ctx.$t("folders.fileGrid.actions.aiInfo"),onClick:withModifiers($event=>_ctx.$emit("view-details",image),["stop"])},[..._cache[5]||(_cache[5]=[createBaseVNode("i",{class:"fas fa-info-circle"},null,-1)])],8,_hoisted_6)):createCommentVNode("",!0),createBaseVNode("button",{class:"action-btn copy-btn",title:_ctx.$t("folders.fileGrid.actions.copyLink"),onClick:withModifiers($event=>_ctx.$emit("copy-link",image),["stop"])},[..._cache[6]||(_cache[6]=[createBaseVNode("i",{class:"fas fa-link"},null,-1)])],8,_hoisted_7),createBaseVNode("button",{class:"action-btn download-btn",title:_ctx.$t("folders.fileGrid.actions.download"),onClick:withModifiers($event=>_ctx.$emit("download-image",image),["stop"])},[..._cache[7]||(_cache[7]=[createBaseVNode("i",{class:"fas fa-download"},null,-1)])],8,_hoisted_8),__props.preview?createCommentVNode("",!0):(openBlock(),createElementBlock("button",{key:1,class:"action-btn delete-btn",title:_ctx.$t("folders.fileGrid.actions.delete"),onClick:withModifiers($event=>_ctx.$emit("delete-image",image),["stop"])},[..._cache[8]||(_cache[8]=[createBaseVNode("i",{class:"fas fa-trash"},null,-1)])],8,_hoisted_9))])])):createCommentVNode("",!0)])),[[_directive_loading,imageLoadingStates.value[image.id]]]),createBaseVNode("div",_hoisted_10,[createBaseVNode("div",{class:"image-name",title:image.display_name},toDisplayString(image.display_name),9,_hoisted_11),createBaseVNode("div",_hoisted_12,[createBaseVNode("span",{class:"image-size",title:_ctx.$t("folders.fileGrid.meta.size")},[_cache[9]||(_cache[9]=createBaseVNode("i",{class:"fas fa-file-image"},null,-1)),createTextVNode(" "+toDisplayString(formatFileSize(image.size)),1)],8,_hoisted_13),image.width&&image.height?(openBlock(),createElementBlock("span",{key:0,class:"image-dimensions",title:_ctx.$t("folders.fileGrid.meta.dimensions")},[_cache[10]||(_cache[10]=createBaseVNode("i",{class:"fas fa-expand"},null,-1)),createTextVNode(" "+toDisplayString(image.width)+"x"+toDisplayString(image.height),1)],8,_hoisted_14)):createCommentVNode("",!0)])])],42,_hoisted_1))),128))]),_:1},8,["modelValue","disabled"]),createVNode(_component_CyberContextMenu,{modelValue:unref(showContextMenu),"onUpdate:modelValue":_cache[3]||(_cache[3]=$event=>isRef(showContextMenu)?showContextMenu.value=$event:null),items:unref(contextMenuItems),x:unref(contextMenuPosition).x,y:unref(contextMenuPosition).y,onClose:unref(hideContextMenu)},null,8,["modelValue","items","x","y","onClose"])],64)}}});const FilesGridView=_export_sfc(_sfc_main,[["__scopeId","data-v-f7d8e5d1"]]);export{FilesGridView as F};
