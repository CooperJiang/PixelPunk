import{j as useTexts,_ as _export_sfc,J as getCurrentLocale,v as logger}from"./index-38202212.js";import{d as defineComponent,r as ref,c as computed,b as onMounted,z as openBlock,I as createElementBlock,a0 as createBaseVNode,F as Fragment,M as renderList,Q as normalizeStyle,a1 as toDisplayString,u as unref,a5 as withModifiers,R as normalizeClass,K as createCommentVNode,ab as createTextVNode,w as watch,o as onUnmounted,A as createBlock,n as nextTick,ac as createStaticVNode,f as createVNode}from"./vue-vendor-31320f47.js";import{c as getGuestFileList}from"./index-1b22a359.js";import{s as setCssVariable}from"./domUtils-0c63d6d8.js";import"./editor-markdown-0b2e1ce5.js";import"./axios-c2a59b9f.js";import"./spark-md5-d0a97131.js";import"./highlight-common-d6c232ae.js";import"./comlink-c7be92b7.js";/* empty css                 */import"./vueuse-2480d07f.js";import"./marked-e9418aa8.js";import"./dompurify-76a35038.js";import"./vue-table-79795ca5.js";const _hoisted_1$2={class:"honeycomb-content"},_hoisted_2$2={key:0,class:"honeycomb-loading"},_hoisted_3$2={class:"loading-spinner"},_hoisted_4$2={class:"loading-text"},_hoisted_5$2={key:1,class:"honeycomb-error"},_hoisted_6$2={class:"error-text"},_hoisted_7$2=["src","alt"],_hoisted_8$2={key:3,class:"honeycomb-overlay"},_hoisted_9$2={class:"overlay-content"},_hoisted_10$2={class:"overlay-description"},_hoisted_11$2={class:"overlay-meta"},_hoisted_12$1={class:"meta-item"},_hoisted_13$1={key:0,class:"meta-item"},maxRetries=3,_sfc_main$3=defineComponent({__name:"HoneycombCell",props:{imageData:{},position:{},transform:{},currentTransform:{},row:{},col:{}},emits:["click","mouseenter","mouseleave"],setup(__props,{emit:__emit}){const{$t}=useTexts(),props=__props,emit=__emit,isLoading=ref(!1),isLoaded=ref(!1),hasError=ref(!1),retryCount=ref(0),imageUrl=computed(()=>{const baseUrl=props.imageData.full_thumb_url||props.imageData.thumb_url||"";if(!baseUrl)return"";if(retryCount.value>0){const separator=baseUrl.includes("?")?"&":"?";return`${baseUrl}${separator}retry=${retryCount.value}&t=${Date.now()}`}return baseUrl}),description=computed(()=>{const desc=props.imageData.ai_info?.description||""||$t("hive.cell.noDescription");return desc.length>60?`${desc.substring(0,60)}...`:desc}),cellStyle=computed(()=>{const finalTransform=props.currentTransform||props.transform,hasHoverEffect=props.currentTransform&&props.currentTransform!==props.transform;return{position:"absolute",left:`${props.position.x}px`,top:`${props.position.y}px`,transform:finalTransform,transformOrigin:"center center",zIndex:hasHoverEffect?10:1}}),getSpinnerStyle=index2=>{const angle=(index2-1)*60,radius=12,x=Math.cos(angle*Math.PI/180)*radius,y=Math.sin(angle*Math.PI/180)*radius;return{"--x":`${x}px`,"--y":`${y}px`,animationDelay:`${(index2-1)*.1}s`}},formatFileSize=bytes=>{if(bytes===0)return"0 B";const k=1024,sizes=["B","KB","MB","GB"],i=Math.floor(Math.log(bytes)/Math.log(k));return`${parseFloat((bytes/Math.pow(k,i)).toFixed(1))} ${sizes[i]}`},handleImageLoad=()=>{isLoading.value=!1,isLoaded.value=!0,hasError.value=!1,retryCount.value=0},handleImageError=()=>{isLoading.value=!1,isLoaded.value=!1,hasError.value=!0,retryCount.value<maxRetries&&setTimeout(()=>{hasError.value&&retryCount.value<maxRetries&&retryLoad()},1e3*(retryCount.value+1))},retryLoad=()=>{retryCount.value>=maxRetries&&(retryCount.value=0),isLoading.value=!0,isLoaded.value=!1,hasError.value=!1,imageUrl.value&&retryCount.value++},handleImageClick=()=>{isLoaded.value&&!hasError.value&&emit("click",props.imageData)},handleClick=()=>{hasError.value?retryLoad():isLoaded.value&&emit("click",props.imageData)},handleMouseEnter=()=>{emit("mouseenter",props.row,props.col)},handleMouseLeave=e=>{emit("mouseleave",e)};return onMounted(()=>{imageUrl.value||(isLoading.value=!1,hasError.value=!0)}),(_ctx,_cache)=>(openBlock(),createElementBlock("div",{class:"honeycomb-item",style:normalizeStyle(cellStyle.value),onClick:handleClick,onMouseenter:handleMouseEnter,onMouseleave:handleMouseLeave},[createBaseVNode("div",_hoisted_1$2,[isLoading.value?(openBlock(),createElementBlock("div",_hoisted_2$2,[createBaseVNode("div",_hoisted_3$2,[(openBlock(),createElementBlock(Fragment,null,renderList(6,i=>createBaseVNode("div",{key:i,class:"hex-spinner",style:normalizeStyle(getSpinnerStyle(i))},null,4)),64))]),createBaseVNode("div",_hoisted_4$2,toDisplayString(unref($t)("hive.cell.reloading")),1)])):hasError.value?(openBlock(),createElementBlock("div",_hoisted_5$2,[_cache[1]||(_cache[1]=createBaseVNode("div",{class:"error-icon"},[createBaseVNode("i",{class:"fas fa-exclamation-triangle"})],-1)),createBaseVNode("div",_hoisted_6$2,toDisplayString(unref($t)("hive.cell.loadFailed")),1),createBaseVNode("div",{class:"error-retry",onClick:withModifiers(retryLoad,["stop"])},[_cache[0]||(_cache[0]=createBaseVNode("i",{class:"fas fa-redo"},null,-1)),createBaseVNode("span",null,toDisplayString(unref($t)("hive.cell.retry")),1)])])):imageUrl.value?(openBlock(),createElementBlock("img",{key:2,src:imageUrl.value,alt:unref($t)("hive.cell.imageAlt"),class:normalizeClass(["honeycomb-image",{"image-loaded":isLoaded.value}]),onLoad:handleImageLoad,onError:handleImageError,onClick:withModifiers(handleImageClick,["stop"])},null,42,_hoisted_7$2)):createCommentVNode("",!0),isLoaded.value&&!hasError.value?(openBlock(),createElementBlock("div",_hoisted_8$2,[createBaseVNode("div",_hoisted_9$2,[createBaseVNode("div",_hoisted_10$2,toDisplayString(description.value),1),createBaseVNode("div",_hoisted_11$2,[createBaseVNode("span",_hoisted_12$1,[_cache[2]||(_cache[2]=createBaseVNode("i",{class:"fas fa-eye"},null,-1)),createTextVNode(" "+toDisplayString(__props.imageData.views||0),1)]),__props.imageData.size?(openBlock(),createElementBlock("span",_hoisted_13$1,[_cache[3]||(_cache[3]=createBaseVNode("i",{class:"fas fa-file"},null,-1)),createTextVNode(" "+toDisplayString(formatFileSize(__props.imageData.size)),1)])):createCommentVNode("",!0)])])])):createCommentVNode("",!0)])],36))}});const HoneycombCell=_export_sfc(_sfc_main$3,[["__scopeId","data-v-28f09ef4"]]),_sfc_main$2=defineComponent({__name:"HoneycombCanvas",props:{images:{},horizontalGap:{},verticalGap:{},strength3D:{}},emits:["loadMore","imageClick"],setup(__props,{expose:__expose,emit:__emit}){const props=__props,emit=__emit,canvasContainer=ref(),honeycombCanvas=ref(),isDragging=ref(!1),lastMouseX=ref(0),lastMouseY=ref(0),canvasOffsetX=ref(0),canvasOffsetY=ref(0),dragDistance=ref(0),visibleCells=ref([]),cellsMap=new Map,canvasStyle=computed(()=>({transform:`translate(${canvasOffsetX.value}px, ${canvasOffsetY.value}px)`})),calculateLayout=()=>{const viewportWidth=window.innerWidth,itemsPerOddRow=Math.floor(viewportWidth/180),itemsPerEvenRow=itemsPerOddRow+1,actualItemSize=Math.floor(viewportWidth/itemsPerOddRow),hexHeight=actualItemSize*1.1547,verticalSpacing=actualItemSize*props.verticalGap,horizontalSpacing=actualItemSize*(1+props.horizontalGap);return{itemSize:actualItemSize,itemsPerOddRow,itemsPerEvenRow,rowHeight:hexHeight*.75+verticalSpacing,horizontalSpacing}},getCellKey=(row,col)=>`${row}_${col}`,usedImagesInViewport=new Map,imageUsageCount=new Map,getRegionKey=(row,col)=>{const regionRow=Math.floor(row/6),regionCol=Math.floor(col/6);return`${regionRow}_${regionCol}`},cleanupDistantRegions=(currentRow,currentCol)=>{const currentRegionRow=Math.floor(currentRow/6),currentRegionCol=Math.floor(currentCol/6),cleanupDistance=10;for(const[regionKey]of usedImagesInViewport){const[regionRow,regionCol]=regionKey.split("_").map(Number);if(Math.max(Math.abs(regionRow-currentRegionRow),Math.abs(regionCol-currentRegionCol))>cleanupDistance){const usedSet=usedImagesInViewport.get(regionKey);if(usedSet)for(const imageIndex of usedSet){const currentCount=imageUsageCount.get(imageIndex)||0;currentCount<=1?imageUsageCount.delete(imageIndex):imageUsageCount.set(imageIndex,currentCount-usedSet.size)}usedImagesInViewport.delete(regionKey)}}},getImageFromPool=(row,col)=>{if(props.images.length===0)return null;const regionKey=getRegionKey(row,col);Math.random()<.01&&cleanupDistantRegions(row,col),usedImagesInViewport.has(regionKey)||usedImagesInViewport.set(regionKey,new Set);const usedInRegion=usedImagesInViewport.get(regionKey),adjacentUsed=new Set;for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){const adjRegionRow=Math.floor(row/6)+dr,adjRegionCol=Math.floor(col/6)+dc,adjRegionKey=`${adjRegionRow}_${adjRegionCol}`,adjUsed=usedImagesInViewport.get(adjRegionKey);if(adjUsed)for(const imageIndex of adjUsed)adjacentUsed.add(imageIndex)}const candidates=[],fallbackCandidates=[];for(let i=0;i<props.images.length;i++)!usedInRegion.has(i)&&!adjacentUsed.has(i)?candidates.push(i):usedInRegion.has(i)||fallbackCandidates.push(i);let selectedIndex;if(candidates.length>0){candidates.sort((a,b)=>{const usageA=imageUsageCount.get(a)||0,usageB=imageUsageCount.get(b)||0;return usageA-usageB});const topCandidates=candidates.slice(0,Math.min(5,candidates.length));selectedIndex=topCandidates[Math.floor(Math.random()*topCandidates.length)]}else if(fallbackCandidates.length>0){fallbackCandidates.sort((a,b)=>{const usageA=imageUsageCount.get(a)||0,usageB=imageUsageCount.get(b)||0;return usageA-usageB});const topFallbacks=fallbackCandidates.slice(0,Math.min(3,fallbackCandidates.length));selectedIndex=topFallbacks[Math.floor(Math.random()*topFallbacks.length)]}else{const allIndices=Array.from({length:props.images.length},(_,i)=>i);allIndices.sort((a,b)=>{const usageA=imageUsageCount.get(a)||0,usageB=imageUsageCount.get(b)||0;return usageA-usageB}),selectedIndex=allIndices[0]}usedInRegion.add(selectedIndex);const currentUsage=imageUsageCount.get(selectedIndex)||0;return imageUsageCount.set(selectedIndex,currentUsage+1),props.images[selectedIndex]},calculate3DTransform=(x,y)=>{const centerX=window.innerWidth/2,centerY=window.innerHeight/2,distanceFromCenterX=(x-centerX+canvasOffsetX.value)/window.innerWidth,distanceFromCenterY=(y-centerY+canvasOffsetY.value)/window.innerHeight,rotateY=distanceFromCenterX*(25*props.strength3D),rotateX=distanceFromCenterY*(12*props.strength3D),translateZ=-Math.abs(distanceFromCenterX)*(150*props.strength3D)-50*props.strength3D;return`rotateY(${rotateY}deg) rotateX(${rotateX}deg) translateZ(${translateZ}px)`},getVisibleRange=layout=>{const viewportLeft=-canvasOffsetX.value,viewportTop=-canvasOffsetY.value,viewportRight=viewportLeft+window.innerWidth,viewportBottom=viewportTop+window.innerHeight,startRow=Math.floor(viewportTop/layout.rowHeight)-2,endRow=Math.ceil(viewportBottom/layout.rowHeight)+2,startCol=Math.floor(viewportLeft/layout.horizontalSpacing)-2,endCol=Math.ceil(viewportRight/layout.horizontalSpacing)+2;return{startRow,endRow,startCol,endCol}},updateVisibleContent=()=>{if(props.images.length===0)return;const layout=calculateLayout(),range=getVisibleRange(layout),cellsToKeep=new Set;for(let row=range.startRow;row<=range.endRow;row++){const isEvenRow=row%2===0;for(let col=range.startCol;col<=range.endCol;col++){const key=getCellKey(row,col);if(cellsToKeep.add(key),cellsMap.has(key)){const index2=cellsMap.get(key),cell=visibleCells.value[index2],x=col*layout.horizontalSpacing+(isEvenRow?0:layout.horizontalSpacing*.5),y=row*layout.rowHeight,newBaseTransform=calculate3DTransform(x,y),hasHoverTransform=cell.currentTransform&&cell.currentTransform!==cell.transform,updatedCell={...cell,position:{x,y},transform:newBaseTransform};hasHoverTransform||(updatedCell.currentTransform=newBaseTransform),visibleCells.value[index2]=updatedCell}else{const imageData=getImageFromPool(row,col);if(imageData){const x=col*layout.horizontalSpacing+(isEvenRow?0:layout.horizontalSpacing*.5),y=row*layout.rowHeight,baseTransform=calculate3DTransform(x,y);visibleCells.value.push({imageData,position:{x,y},transform:baseTransform,currentTransform:baseTransform,row,col}),cellsMap.set(key,visibleCells.value.length-1)}}}}for(let i=visibleCells.value.length-1;i>=0;i--){const key=getCellKey(visibleCells.value[i].row,visibleCells.value[i].col);cellsToKeep.has(key)||(visibleCells.value.splice(i,1),cellsMap.delete(key),cellsMap.clear(),visibleCells.value.forEach((cell,index2)=>{const cellKey=getCellKey(cell.row,cell.col);cellsMap.set(cellKey,index2)}))}},resetImageTracking=()=>{usedImagesInViewport.clear(),imageUsageCount.clear()},updateLayout=()=>{const layout=calculateLayout();document.documentElement.style.setProperty("--item-size",`${layout.itemSize}px`),visibleCells.value=[],cellsMap.clear(),resetImageTracking(),updateVisibleContent()},handleCellClick=imageData=>{dragDistance.value<10&&emit("imageClick",imageData)},handleCellHover=(row,col)=>{if(isDragging.value)return;clearHoverEffects();const currentKey=getCellKey(row,col),currentIndex=cellsMap.get(currentKey);if(currentIndex===void 0)return;applyHoverScale(visibleCells.value[currentIndex],1.15),getNeighborCells(row,col).forEach(neighbor=>{applyHoverScale(neighbor,.85)})},handleCellLeave=e=>{const relatedTarget=e.relatedTarget;relatedTarget&&relatedTarget.closest(".honeycomb-item")||clearHoverEffects()},getNeighborCells=(row,col)=>{const neighbors=[];return(row%2===0?[{row:0,col:-1},{row:0,col:1},{row:-1,col:-1},{row:-1,col:0},{row:1,col:-1},{row:1,col:0}]:[{row:0,col:-1},{row:0,col:1},{row:-1,col:0},{row:-1,col:1},{row:1,col:0},{row:1,col:1}]).forEach(offset=>{const neighborRow=row+offset.row,neighborCol=col+offset.col,key=getCellKey(neighborRow,neighborCol),neighborIndex=cellsMap.get(key);neighborIndex!==void 0&&neighbors.push(visibleCells.value[neighborIndex])}),neighbors},clearHoverEffects=()=>{for(const cell of visibleCells.value)removeHoverScale(cell)},applyHoverScale=(cell,scale)=>{const newTransform=`${cell.transform} scale(${scale})`,key=getCellKey(cell.row,cell.col),index2=cellsMap.get(key);index2!==void 0&&(visibleCells.value[index2]={...cell,currentTransform:newTransform}),nextTick(()=>{})},removeHoverScale=cell=>{const key=getCellKey(cell.row,cell.col),index2=cellsMap.get(key);index2!==void 0&&(visibleCells.value[index2]={...cell,currentTransform:cell.transform}),nextTick(()=>{})},handleMouseDown=e=>{isDragging.value=!0,lastMouseX.value=e.clientX,lastMouseY.value=e.clientY,dragDistance.value=0,e.preventDefault()},handleMouseMove=e=>{if(!isDragging.value)return;const deltaX=e.clientX-lastMouseX.value,deltaY=e.clientY-lastMouseY.value;canvasOffsetX.value+=deltaX,canvasOffsetY.value+=deltaY,dragDistance.value+=Math.abs(deltaX)+Math.abs(deltaY),updateVisibleContent(),checkLoadMoreNeeded(),lastMouseX.value=e.clientX,lastMouseY.value=e.clientY},handleMouseUp=()=>{isDragging.value=!1},handleTouchStart=e=>{e.preventDefault(),isDragging.value=!0;const touch=e.touches[0];lastMouseX.value=touch.clientX,lastMouseY.value=touch.clientY,dragDistance.value=0},handleTouchMove=e=>{if(!isDragging.value)return;e.preventDefault();const touch=e.touches[0],deltaX=touch.clientX-lastMouseX.value,deltaY=touch.clientY-lastMouseY.value;canvasOffsetX.value+=deltaX,canvasOffsetY.value+=deltaY,dragDistance.value+=Math.abs(deltaX)+Math.abs(deltaY),updateVisibleContent(),checkLoadMoreNeeded(),lastMouseX.value=touch.clientX,lastMouseY.value=touch.clientY},handleTouchEnd=e=>{e.preventDefault(),isDragging.value=!1},checkLoadMoreNeeded=()=>{if(props.images.length===0)return;const layout=calculateLayout(),range=getVisibleRange(layout),visibleRows=range.endRow-range.startRow+1,visibleCols=range.endCol-range.startCol+1,avgItemsPerRow=(layout.itemsPerOddRow+layout.itemsPerEvenRow)/2,currentUsageRatio=Math.ceil(visibleRows*avgItemsPerRow)/props.images.length,horizontalExpansion=visibleCols>avgItemsPerRow*1.5;(currentUsageRatio>.6||horizontalExpansion&&currentUsageRatio>.4)&&emit("loadMore")},handleResize=()=>{updateLayout()};return watch(()=>props.images.length,(newLength,oldLength)=>{newLength!==oldLength&&(resetImageTracking(),newLength>0&&nextTick(()=>{updateVisibleContent()}))},{immediate:!1}),onMounted(()=>{document.addEventListener("mousemove",handleMouseMove),document.addEventListener("mouseup",handleMouseUp),document.addEventListener("touchmove",handleTouchMove),document.addEventListener("touchend",handleTouchEnd),window.addEventListener("resize",handleResize),updateLayout()}),onUnmounted(()=>{document.removeEventListener("mousemove",handleMouseMove),document.removeEventListener("mouseup",handleMouseUp),document.removeEventListener("touchmove",handleTouchMove),document.removeEventListener("touchend",handleTouchEnd),window.removeEventListener("resize",handleResize)}),__expose({updateVisibleContent,updateLayout}),(_ctx,_cache)=>(openBlock(),createElementBlock("div",{ref_key:"canvasContainer",ref:canvasContainer,class:normalizeClass(["canvas-container",{dragging:isDragging.value}]),onMousedown:handleMouseDown,onTouchstart:handleTouchStart},[createBaseVNode("div",{ref_key:"honeycombCanvas",ref:honeycombCanvas,class:"honeycomb-canvas",style:normalizeStyle(canvasStyle.value)},[(openBlock(!0),createElementBlock(Fragment,null,renderList(visibleCells.value,cell=>(openBlock(),createBlock(HoneycombCell,{key:`${cell.row}_${cell.col}`,"image-data":cell.imageData,position:cell.position,transform:cell.transform,"current-transform":cell.currentTransform,row:cell.row,col:cell.col,onClick:handleCellClick,onMouseenter:handleCellHover,onMouseleave:handleCellLeave},null,8,["image-data","position","transform","current-transform","row","col"]))),128))],4)],34))}});const HoneycombCanvas=_export_sfc(_sfc_main$2,[["__scopeId","data-v-bdb2c437"]]),_hoisted_1$1={class:"preview-header"},_hoisted_2$1={class:"preview-title"},_hoisted_3$1={class:"header-actions"},_hoisted_4$1=["disabled"],_hoisted_5$1={class:"preview-content"},_hoisted_6$1={class:"preview-image-section"},_hoisted_7$1={class:"preview-image-wrapper"},_hoisted_8$1={key:0,class:"image-loading"},_hoisted_9$1={class:"loading-text"},_hoisted_10$1={class:"loading-dots"},_hoisted_11$1=["src","alt"],_hoisted_12={key:2,class:"image-error"},_hoisted_13={class:"error-text"},_hoisted_14={key:0,class:"preview-info"},_hoisted_15={class:"info-grid"},_hoisted_16={class:"info-item"},_hoisted_17={class:"info-label"},_hoisted_18={class:"info-value"},_hoisted_19={key:0,class:"info-item"},_hoisted_20={class:"info-label"},_hoisted_21={class:"info-value"},_hoisted_22={key:1,class:"info-item"},_hoisted_23={class:"info-label"},_hoisted_24={class:"info-value"},_hoisted_25={class:"info-item"},_hoisted_26={class:"info-label"},_hoisted_27={class:"info-value"},_hoisted_28={key:2,class:"info-item"},_hoisted_29={class:"info-label"},_hoisted_30={class:"info-value"},_sfc_main$1=defineComponent({__name:"FilePreview",props:{show:{type:Boolean},imageData:{}},emits:["close"],setup(__props,{emit:__emit}){const props=__props,emit=__emit,loading=ref(!1),imageLoaded=ref(!1);watch(()=>props.imageData,newImageData=>{newImageData&&props.show&&loadImage(newImageData.full_url)},{immediate:!0}),watch(()=>props.show,newShow=>{newShow&&props.imageData?loadImage(props.imageData.full_url):resetState()});const loadImage=url=>{loading.value=!0,imageLoaded.value=!1;const img=new Image;img.onload=()=>{loading.value=!1,imageLoaded.value=!0},img.onerror=()=>{loading.value=!1,imageLoaded.value=!1},img.src=url},resetState=()=>{loading.value=!1,imageLoaded.value=!1},closePreview=()=>{emit("close")},handleOverlayClick=()=>{closePreview()},downloadImage=async()=>{if(!(!props.imageData||!imageLoaded.value))try{const blob=await(await fetch(props.imageData.full_url)).blob(),url=window.URL.createObjectURL(blob),link=document.createElement("a");link.href=url,link.download=props.imageData.display_name||props.imageData.original_name||"image",document.body.appendChild(link),link.click(),document.body.removeChild(link),window.URL.revokeObjectURL(url)}catch{return}},formatFileSize=bytes=>{if(bytes===0)return"0 Bytes";const k=1024,sizes=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(bytes)/Math.log(k));return`${parseFloat((bytes/Math.pow(k,i)).toFixed(2))} ${sizes[i]}`},formatDate=dateString=>new Date(dateString).toLocaleString(getCurrentLocale(),{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});return(_ctx,_cache)=>__props.show?(openBlock(),createElementBlock("div",{key:0,class:"image-preview-overlay",onClick:handleOverlayClick},[createBaseVNode("div",{class:"preview-container",onClick:_cache[0]||(_cache[0]=withModifiers(()=>{},["stop"]))},[createBaseVNode("div",_hoisted_1$1,[createBaseVNode("div",_hoisted_2$1,[_cache[1]||(_cache[1]=createBaseVNode("div",{class:"title-icon"},[createBaseVNode("i",{class:"fas fa-image"})],-1)),createBaseVNode("span",null,toDisplayString(_ctx.$t("hive.preview.title")),1)]),createBaseVNode("div",_hoisted_3$1,[createBaseVNode("button",{class:"action-btn download-btn",disabled:!imageLoaded.value,onClick:downloadImage},[..._cache[2]||(_cache[2]=[createBaseVNode("i",{class:"fas fa-download"},null,-1)])],8,_hoisted_4$1),createBaseVNode("button",{class:"action-btn close-btn",onClick:closePreview},[..._cache[3]||(_cache[3]=[createBaseVNode("i",{class:"fas fa-times"},null,-1)])])])]),createBaseVNode("div",_hoisted_5$1,[createBaseVNode("div",_hoisted_6$1,[createBaseVNode("div",_hoisted_7$1,[loading.value?(openBlock(),createElementBlock("div",_hoisted_8$1,[_cache[5]||(_cache[5]=createStaticVNode('<div class="cyber-loader" data-v-179dffbd><div class="loader-ring" data-v-179dffbd></div><div class="loader-ring" data-v-179dffbd></div><div class="loader-ring" data-v-179dffbd></div><div class="loader-core" data-v-179dffbd></div></div>',1)),createBaseVNode("div",_hoisted_9$1,[createBaseVNode("span",_hoisted_10$1,toDisplayString(_ctx.$t("hive.preview.loading")),1),_cache[4]||(_cache[4]=createBaseVNode("span",{class:"dots"},"...",-1))])])):imageLoaded.value?(openBlock(),createElementBlock("img",{key:1,src:__props.imageData?.full_url,alt:__props.imageData?.display_name||_ctx.$t("hive.preview.imageAlt"),class:"preview-image"},null,8,_hoisted_11$1)):(openBlock(),createElementBlock("div",_hoisted_12,[_cache[6]||(_cache[6]=createBaseVNode("div",{class:"error-icon"},[createBaseVNode("i",{class:"fas fa-exclamation-triangle"})],-1)),createBaseVNode("div",_hoisted_13,toDisplayString(_ctx.$t("hive.preview.error")),1)]))]),__props.imageData?(openBlock(),createElementBlock("div",_hoisted_14,[createBaseVNode("div",_hoisted_15,[createBaseVNode("div",_hoisted_16,[createBaseVNode("span",_hoisted_17,toDisplayString(_ctx.$t("hive.preview.info.name")),1),createBaseVNode("span",_hoisted_18,toDisplayString(__props.imageData.display_name||__props.imageData.original_name||_ctx.$t("hive.preview.info.unnamed")),1)]),__props.imageData.ai_info?.description?(openBlock(),createElementBlock("div",_hoisted_19,[createBaseVNode("span",_hoisted_20,toDisplayString(_ctx.$t("hive.preview.info.description")),1),createBaseVNode("span",_hoisted_21,toDisplayString(__props.imageData.ai_info.description),1)])):createCommentVNode("",!0),__props.imageData.width&&__props.imageData.height?(openBlock(),createElementBlock("div",_hoisted_22,[createBaseVNode("span",_hoisted_23,toDisplayString(_ctx.$t("hive.preview.info.size")),1),createBaseVNode("span",_hoisted_24,toDisplayString(__props.imageData.width)+"Ã—"+toDisplayString(__props.imageData.height),1)])):createCommentVNode("",!0),createBaseVNode("div",_hoisted_25,[createBaseVNode("span",_hoisted_26,toDisplayString(_ctx.$t("hive.preview.info.fileSize")),1),createBaseVNode("span",_hoisted_27,toDisplayString(formatFileSize(__props.imageData.size)),1)]),__props.imageData.created_at?(openBlock(),createElementBlock("div",_hoisted_28,[createBaseVNode("span",_hoisted_29,toDisplayString(_ctx.$t("hive.preview.info.createTime")),1),createBaseVNode("span",_hoisted_30,toDisplayString(formatDate(__props.imageData.created_at)),1)])):createCommentVNode("",!0)])])):createCommentVNode("",!0)])])])])):createCommentVNode("",!0)}});const FilePreview=_export_sfc(_sfc_main$1,[["__scopeId","data-v-179dffbd"]]);function useEventListener(target,event,handler){onMounted(()=>{target==="window"?window.addEventListener(event,handler):document.addEventListener(event,handler)}),onUnmounted(()=>{target==="window"?window.removeEventListener(event,handler):document.removeEventListener(event,handler)})}const PAGE_SIZE=96,PROGRESS_INITIAL=5,PROGRESS_DATA_LOADED=15,PROGRESS_PRELOAD_START=20,PROGRESS_PRELOAD_RANGE=80,PROGRESS_COMPLETE=100,ERROR_DISPLAY_DURATION=5e3,LOADING_MIN_DISPLAY_TIME=1500,LOADING_FADEOUT_DURATION=500,COMPONENT_RENDER_WAIT_TIME=500,ELEMENT_CHECK_INTERVAL=300,RENDER_RETRY_INTERVAL=200,MAX_RENDER_ATTEMPTS=10,HEX_SIZE_MIN=10,HEX_SIZE_RANGE=30,HEX_POSITION_RANGE=100,HEX_ANIMATION_DELAY_MAX=5,LOADER_HEX_ANGLE_STEP=60,LOADER_HEX_RADIUS=40,LOADER_HEX_ANIMATION_DELAY_STEP=.1,BACKGROUND_HEX_COUNT=20,LOADER_HEX_COUNT=7,ITEM_SIZE=180,ROW_HEIGHT_RATIO=.75,ITEMS_PER_ROW_BUFFER=2,VISIBLE_ROWS_BUFFER=4,MAX_VISIBLE_COUNT=60,DEFAULT_HORIZONTAL_GAP=0,DEFAULT_VERTICAL_GAP=0,DEFAULT_STRENGTH_3D=1,DEFAULT_CLIP_GAP=3;function useHiveData(){const{$t}=useTexts(),images=ref([]),isLoading=ref(!1),isInitialLoading=ref(!0),isLoadingFadingOut=ref(!1),error=ref(""),currentPage=ref(1),hasMorePages=ref(!0),loadingProgress=ref(0),loadingStartTime=ref(Date.now());let canvasRefCallback=null;const setCanvasUpdateCallback=callback=>{canvasRefCallback=callback},getViewportDimensions=()=>({width:window.innerWidth,height:window.innerHeight}),calculateVisibleImageCount=()=>{const{width,height}=getViewportDimensions(),itemsPerRow=Math.floor(width/ITEM_SIZE)+ITEMS_PER_ROW_BUFFER,rowsVisible=Math.floor(height/(ITEM_SIZE*ROW_HEIGHT_RATIO))+VISIBLE_ROWS_BUFFER;return Math.min(itemsPerRow*rowsVisible,MAX_VISIBLE_COUNT)},loadFiles=async(page=1,append=!1)=>{if(!(isLoading.value||!hasMorePages.value)){isLoading.value=!0,error.value="",!append&&isInitialLoading.value&&(loadingProgress.value=PROGRESS_INITIAL);try{const response=await getGuestFileList({page,size:PAGE_SIZE,sort:"newest"}),newImages=response?.data?.items||[];if(!append&&isInitialLoading.value&&(loadingProgress.value=PROGRESS_DATA_LOADED),newImages.length===0){hasMorePages.value=!1;return}append?images.value=[...images.value,...newImages]:(images.value=newImages,currentPage.value=page,isInitialLoading.value&&(loadingProgress.value=PROGRESS_PRELOAD_START)),response.data.pagination&&(hasMorePages.value=response.data.pagination.current_page<response.data.pagination.last_page),await nextTick(),canvasRefCallback?.()}catch(err){const message=err instanceof Error?err.message:$t("hive.errors.unknown");error.value=$t("hive.errors.loadFailedWithReason",{message}),isInitialLoading.value&&(isInitialLoading.value=!1),setTimeout(()=>{error.value=""},ERROR_DISPLAY_DURATION)}finally{isLoading.value=!1}}};return{images,isLoading,isInitialLoading,isLoadingFadingOut,error,currentPage,hasMorePages,loadingProgress,loadingStartTime,loadFiles,loadMoreImages:()=>{hasMorePages.value&&!isLoading.value&&(currentPage.value++,loadFiles(currentPage.value,!0))},preloadVisibleFiles:async fileList=>{const visibleCount=calculateVisibleImageCount(),filesToLoad=fileList.slice(0,visibleCount);if(filesToLoad.length===0){loadingProgress.value=PROGRESS_COMPLETE;return}let loadedCount=0;const totalCount=filesToLoad.length,loadFile=file=>new Promise(resolve=>{const img=new window.Image,updateProgress=()=>{loadedCount++;const progress=PROGRESS_PRELOAD_START+Math.round(loadedCount/totalCount*PROGRESS_PRELOAD_RANGE);loadingProgress.value=progress,resolve()};img.onload=updateProgress,img.onerror=updateProgress;const fileUrl=file.full_thumb_url||file.thumb_url;fileUrl?img.src=fileUrl:updateProgress()});await Promise.all(filesToLoad.map(loadFile)),loadingProgress.value=PROGRESS_COMPLETE},setCanvasUpdateCallback}}function useHiveUI(){const isFullscreen=ref(!1),tipsHidden=ref(!1),viewportWidth=ref(0),viewportHeight=ref(0),showPreview=ref(!1),previewFile=ref(null),getViewportDimensions=()=>({width:window.innerWidth,height:window.innerHeight}),updateViewportDimensions=()=>{const{width,height}=getViewportDimensions();viewportWidth.value=width,viewportHeight.value=height,setCssVariable("viewport-width",`${width}px`),setCssVariable("viewport-height",`${height}px`)},toggleTips=()=>{tipsHidden.value=!tipsHidden.value},toggleFullscreen=async()=>{try{document.fullscreenElement?await document.exitFullscreen():await document.documentElement.requestFullscreen()}catch(error){logger.error("Fullscreen toggle failed:",error)}};return{isFullscreen,tipsHidden,viewportWidth,viewportHeight,showPreview,previewFile,updateViewportDimensions,toggleTips,toggleFullscreen,handleFullscreenChange:()=>{isFullscreen.value=!!document.fullscreenElement},handleFileClick:file=>{previewFile.value=file,showPreview.value=!0},closePreview:()=>{showPreview.value=!1,previewFile.value=null},handleKeydown:e=>{switch(e.key){case"f":case"F":e.preventDefault(),toggleFullscreen();break;case"Escape":document.fullscreenElement&&document.exitFullscreen();break}}}}async function waitForComponentRender(){await nextTick(),await new Promise(resolve=>setTimeout(resolve,COMPONENT_RENDER_WAIT_TIME));let attempts=0;for(;attempts<MAX_RENDER_ATTEMPTS;){if(document.querySelectorAll(".honeycomb-item").length>0){await new Promise(resolve=>setTimeout(resolve,ELEMENT_CHECK_INTERVAL));return}attempts++,await new Promise(resolve=>setTimeout(resolve,RENDER_RETRY_INTERVAL))}}function useHiveInit(loadFiles,preloadVisibleFiles,images,isInitialLoading,isLoadingFadingOut,loadingStartTime){return{initializeHoneycomb:async()=>{try{await loadFiles(1,!1),images.value.length>0&&(await preloadVisibleFiles(images.value),await waitForComponentRender());const elapsedTime=Date.now()-loadingStartTime.value,remainingTime=Math.max(0,LOADING_MIN_DISPLAY_TIME-elapsedTime);remainingTime>0&&await new Promise(resolve=>setTimeout(resolve,remainingTime)),isLoadingFadingOut.value=!0,await new Promise(resolve=>setTimeout(resolve,LOADING_FADEOUT_DURATION)),isInitialLoading.value=!1,isLoadingFadingOut.value=!1}catch{isInitialLoading.value=!1,isLoadingFadingOut.value=!1}}}}function getHexagonStyle(_i){const size=Math.random()*HEX_SIZE_RANGE+HEX_SIZE_MIN,left=Math.random()*HEX_POSITION_RANGE,top=Math.random()*HEX_POSITION_RANGE,animationDelay=Math.random()*HEX_ANIMATION_DELAY_MAX;return{width:`${size}px`,height:`${size}px`,left:`${left}%`,top:`${top}%`,animationDelay:`${animationDelay}s`}}function getLoaderHexStyle(i){const angle=(i-1)*LOADER_HEX_ANGLE_STEP,x=Math.cos(angle*Math.PI/180)*LOADER_HEX_RADIUS,y=Math.sin(angle*Math.PI/180)*LOADER_HEX_RADIUS;return{transform:`translate(${x}px, ${y}px)`,animationDelay:`${(i-1)*LOADER_HEX_ANIMATION_DELAY_STEP}s`}}const _hoisted_1={class:"loading-content"},_hoisted_2={class:"honeycomb-loader"},_hoisted_3={class:"loading-text"},_hoisted_4={class:"loading-progress-container"},_hoisted_5={class:"progress-bar"},_hoisted_6={class:"progress-text"},_hoisted_7={key:1,class:"error-message"},_hoisted_8={class:"tip-item"},_hoisted_9={class:"tip-item"},_hoisted_10={class:"tip-item"},_hoisted_11={class:"hive-background"},_sfc_main=defineComponent({name:"HivePage",__name:"index",setup(__props){const{$t}=useTexts(),canvasRef=ref(),horizontalGap=ref(DEFAULT_HORIZONTAL_GAP),verticalGap=ref(DEFAULT_VERTICAL_GAP),strength3D=ref(DEFAULT_STRENGTH_3D);ref(DEFAULT_CLIP_GAP);const{images,isLoading:_isLoading,isInitialLoading,isLoadingFadingOut,error,loadingProgress,loadingStartTime,loadFiles,loadMoreImages,preloadVisibleFiles,setCanvasUpdateCallback}=useHiveData();setCanvasUpdateCallback(()=>{canvasRef.value?.updateVisibleContent()});const{isFullscreen,tipsHidden,showPreview,previewFile,updateViewportDimensions,toggleTips,handleFullscreenChange,handleFileClick,closePreview,handleKeydown}=useHiveUI(),{initializeHoneycomb}=useHiveInit(loadFiles,preloadVisibleFiles,images,isInitialLoading,isLoadingFadingOut,loadingStartTime);return watch([horizontalGap,verticalGap],()=>{nextTick(()=>{canvasRef.value?.updateLayout()})},{flush:"post"}),useEventListener("document","keydown",handleKeydown),useEventListener("document","fullscreenchange",handleFullscreenChange),useEventListener("window","resize",updateViewportDimensions),onMounted(()=>{updateViewportDimensions(),initializeHoneycomb()}),(_ctx,_cache)=>(openBlock(),createElementBlock("div",{class:normalizeClass(["hive-container",{"is-fullscreen":unref(isFullscreen)}])},[unref(isInitialLoading)?(openBlock(),createElementBlock("div",{key:0,class:normalizeClass(["loading-overlay",{"fading-out":unref(isLoadingFadingOut)}])},[createBaseVNode("div",_hoisted_1,[createBaseVNode("div",_hoisted_2,[(openBlock(!0),createElementBlock(Fragment,null,renderList(unref(LOADER_HEX_COUNT),i=>(openBlock(),createElementBlock("div",{key:i,class:"hex-loader",style:normalizeStyle(unref(getLoaderHexStyle)(i))},null,4))),128))]),createBaseVNode("div",_hoisted_3,toDisplayString(unref($t)("hive.loading.text")),1),createBaseVNode("div",_hoisted_4,[createBaseVNode("div",_hoisted_5,[createBaseVNode("div",{class:"progress-fill",style:normalizeStyle({width:`${unref(loadingProgress)}%`})},null,4)]),createBaseVNode("div",_hoisted_6,toDisplayString(unref(loadingProgress).toFixed(0))+"%",1)])])],2)):createCommentVNode("",!0),unref(error)?(openBlock(),createElementBlock("div",_hoisted_7,toDisplayString(unref(error)),1)):createCommentVNode("",!0),createBaseVNode("div",{class:normalizeClass(["user-tips",{"tips-hidden":unref(tipsHidden)}])},[createBaseVNode("div",_hoisted_8,[_cache[1]||(_cache[1]=createBaseVNode("i",{class:"fas fa-images"},null,-1)),createTextVNode(" "+toDisplayString(unref($t)("hive.tips.loaded",{count:unref(images).length})),1)]),createBaseVNode("div",_hoisted_9,[_cache[2]||(_cache[2]=createBaseVNode("i",{class:"fas fa-expand"},null,-1)),createTextVNode(" "+toDisplayString(unref($t)("hive.tips.fullscreen")),1)]),createBaseVNode("div",_hoisted_10,[_cache[3]||(_cache[3]=createBaseVNode("i",{class:"fas fa-hand-rock"},null,-1)),createTextVNode(" "+toDisplayString(unref($t)("hive.tips.drag")),1)]),createBaseVNode("button",{class:"tips-toggle",onClick:_cache[0]||(_cache[0]=(...args)=>unref(toggleTips)&&unref(toggleTips)(...args))},[createBaseVNode("i",{class:normalizeClass(["fas",unref(tipsHidden)?"fa-chevron-down":"fa-chevron-up"])},null,2)])],2),unref(isInitialLoading)?createCommentVNode("",!0):(openBlock(),createBlock(HoneycombCanvas,{key:2,ref_key:"canvasRef",ref:canvasRef,images:unref(images),"horizontal-gap":horizontalGap.value,"vertical-gap":verticalGap.value,"strength3-d":strength3D.value,onLoadMore:unref(loadMoreImages),onImageClick:unref(handleFileClick)},null,8,["images","horizontal-gap","vertical-gap","strength3-d","onLoadMore","onImageClick"])),createVNode(FilePreview,{show:unref(showPreview),"image-data":unref(previewFile),onClose:unref(closePreview)},null,8,["show","image-data","onClose"]),createBaseVNode("div",_hoisted_11,[(openBlock(!0),createElementBlock(Fragment,null,renderList(unref(BACKGROUND_HEX_COUNT),i=>(openBlock(),createElementBlock("div",{key:i,class:"hive-hexagon",style:normalizeStyle(unref(getHexagonStyle)(i))},null,4))),128))])],2))}});const index=_export_sfc(_sfc_main,[["__scopeId","data-v-c21fa614"]]);export{index as default};
