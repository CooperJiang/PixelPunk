import{d as defineComponent,r as ref,c as computed,w as watch,E as resolveComponent,z as openBlock,I as createElementBlock,a0 as createBaseVNode,a1 as toDisplayString,u as unref,K as createCommentVNode,ab as createTextVNode,A as createBlock,L as withCtx,f as createVNode,F as Fragment,M as renderList,R as normalizeClass,b as onMounted,o as onUnmounted,G as resolveDirective,H as withDirectives,a as reactive,a6 as Transition}from"./vue-vendor-31320f47.js";import{j as useTexts,J as getCurrentLocale,_ as _export_sfc,X as __unplugin_components_0,g as getSettings,b as batchUpsertSettings,q as useToast}from"./index-38202212.js";import{u as useWebSocketStore}from"./websocket-61b7fea7.js";import{a as getQueueStats,b as getTaggingDiagnosis,c as getAutoProcessingStatus,d as getTaggingStatusList,g as getTaggingStats,e as getTaggingLogs,s as setAutoProcessing,f as setConcurrency,r as retryTagging,h as resetStuckTagging,i as retryFailedAll,t as triggerTagging,j as ignoreTagging,u as unignoreTagging}from"./index-f51adbc6.js";import"./editor-markdown-0b2e1ce5.js";import"./axios-c2a59b9f.js";import"./spark-md5-d0a97131.js";import"./highlight-common-d6c232ae.js";import"./comlink-c7be92b7.js";/* empty css                 */import"./vueuse-2480d07f.js";import"./marked-e9418aa8.js";import"./dompurify-76a35038.js";import"./vue-table-79795ca5.js";function formatTaggingLog(log,$t){const{type,data}=log;try{switch(type){case"tagging.reset_stuck":return $t("admin.tagging.log.reset_stuck",{count:String(data.count||0),time_threshold:String(data.time_threshold||0)});case"tagging.scheduled_scan":return data.errors?$t("admin.tagging.log.scheduled_scan_with_errors",{duration:String(data.duration?.toFixed?.(2)||data.duration||0),reset_count:String(data.reset_count||0),errors:String(data.errors||"")}):$t("admin.tagging.log.scheduled_scan",{duration:String(data.duration?.toFixed?.(2)||data.duration||0),reset_count:String(data.reset_count||0)});case"tagging.ignore":return data.reason?$t("admin.tagging.log.ignore_with_reason",{reason:String(data.reason)}):$t("admin.tagging.log.ignore");case"tagging.unignore":return $t("admin.tagging.log.unignore");case"tagging.retry_failed_all":return $t("admin.tagging.log.retry_failed_all");case"tagging.retry":return $t("admin.tagging.log.retry");case"tagging.ai_completed":return $t("admin.tagging.log.ai_completed",{prompt_tokens:String(data.prompt_tokens||0),completion_tokens:String(data.completion_tokens||0),total_tokens:String(data.total_tokens||0)});default:return`${type}: ${JSON.stringify(data)}`}}catch{return`${type}: ${JSON.stringify(data)}`}}const _hoisted_1$4={class:"tagging-log-list"},_hoisted_2$4={class:"log-header"},_hoisted_3$4={class:"log-info"},_hoisted_4$4={key:0,class:"total-info"},_hoisted_5$4={key:1,class:"log-filter-info"},_hoisted_6$4={class:"log-actions"},_hoisted_7$4={key:0,class:"empty-logs"},_hoisted_8$4={class:"empty-text"},_hoisted_9$4={key:1,class:"log-timeline"},_hoisted_10$3={class:"flex items-center justify-between"},_hoisted_11$3={class:"flex items-center"},_hoisted_12$3={class:"ml-2"},_hoisted_13$3={class:"text-xs text-content-heading"},_hoisted_14$3={class:"text-content"},_hoisted_15$3={class:"text-content-content-disabled text-xs"},_hoisted_16$3={class:"ml-8 mt-1 text-xs text-content-muted"},_hoisted_17$3={key:0,class:"loading-indicator"},_hoisted_18$3={class:"loading-text"},_hoisted_19$2={key:1,class:"no-more-hint"},_sfc_main$4=defineComponent({__name:"TaggingLogList",props:{logs:{},pagination:{},selectedFileId:{}},emits:["load-more","refresh","clear-filter"],setup(__props,{emit:__emit}){const{$t}=useTexts(),props=__props,emit=__emit,logContainer=ref(),isLoadingMore=ref(!1),hasMore=computed(()=>props.logs.length<props.pagination.total),getActionIcon=action=>{const actionIcons={manual:"fas fa-user-cog",auto:"fas fa-robot",system:"fas fa-server",retry:"fas fa-redo",reset:"fas fa-sync-alt",trigger:"fas fa-play",default:"fas fa-info-circle"};return actionIcons[action]||actionIcons.default},getActionColor=action=>{const actionColors={manual:"text-content",auto:"text-green-400",system:"text-yellow-400",retry:"text-error-500",reset:"text-orange-400",trigger:"text-indigo-400",default:"text-content-content-muted"};return actionColors[action]||actionColors.default},getActionDescription=(action,status)=>{const actionDesc=$t(`admin.tagging.logAction.${action}`)||action,statusDesc=$t(`admin.tagging.logStatus.${status}`)||status;return`${actionDesc} ${statusDesc} `},formatTime=timeString=>{try{return new Date(timeString).toLocaleString(getCurrentLocale(),{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return timeString}},handleScroll=async()=>{if(!hasMore.value||isLoadingMore.value||!logContainer.value)return;const{scrollTop,scrollHeight,clientHeight}=logContainer.value,threshold=50;scrollTop+clientHeight>=scrollHeight-threshold&&(isLoadingMore.value=!0,emit("load-more"))};watch(()=>props.logs,()=>{isLoadingMore.value=!1});const handleRefresh=()=>{emit("refresh")},handleClearFilter=()=>{emit("clear-filter")};return(_ctx,_cache)=>{const _component_CyberButton=resolveComponent("CyberButton");return openBlock(),createElementBlock("div",_hoisted_1$4,[createBaseVNode("div",_hoisted_2$4,[createBaseVNode("div",_hoisted_3$4,[__props.pagination.total>0?(openBlock(),createElementBlock("div",_hoisted_4$4,toDisplayString(unref($t)("admin.tagging.logs.loaded",{current:__props.logs.length,total:__props.pagination.total})),1)):createCommentVNode("",!0),__props.selectedFileId?(openBlock(),createElementBlock("span",_hoisted_5$4,[_cache[0]||(_cache[0]=createBaseVNode("i",{class:"fas fa-filter mr-1"},null,-1)),createTextVNode(" "+toDisplayString(unref($t)("admin.tagging.logs.fileFilter",{id:__props.selectedFileId})),1)])):createCommentVNode("",!0)]),createBaseVNode("div",_hoisted_6$4,[__props.selectedFileId?(openBlock(),createBlock(_component_CyberButton,{key:0,type:"warning",onClick:handleClearFilter},{default:withCtx(()=>[_cache[1]||(_cache[1]=createBaseVNode("i",{class:"fas fa-times mr-1"},null,-1)),createTextVNode(toDisplayString(unref($t)("admin.tagging.buttons.showAll")),1)]),_:1})):createCommentVNode("",!0),createVNode(_component_CyberButton,{type:"secondary",onClick:handleRefresh},{default:withCtx(()=>[_cache[2]||(_cache[2]=createBaseVNode("i",{class:"fas fa-refresh mr-1"},null,-1)),createTextVNode(toDisplayString(unref($t)("admin.tagging.buttons.refresh")),1)]),_:1})])]),createBaseVNode("div",{ref_key:"logContainer",ref:logContainer,class:"log-content",onScroll:handleScroll},[__props.logs.length===0?(openBlock(),createElementBlock("div",_hoisted_7$4,[_cache[3]||(_cache[3]=createBaseVNode("div",{class:"empty-icon"},[createBaseVNode("i",{class:"fas fa-file-alt"})],-1)),createBaseVNode("div",_hoisted_8$4,toDisplayString(unref($t)("admin.tagging.logs.noRecords")),1)])):(openBlock(),createElementBlock("div",_hoisted_9$4,[(openBlock(!0),createElementBlock(Fragment,null,renderList(__props.logs,log=>(openBlock(),createElementBlock("div",{key:log.id,class:"log-item mb-2 border-b border-default pb-2 last:mb-0 last:border-b-0 last:pb-0"},[createBaseVNode("div",_hoisted_10$3,[createBaseVNode("div",_hoisted_11$3,[createBaseVNode("div",{class:normalizeClass([getActionColor(log.action),"w-6 text-center"])},[createBaseVNode("i",{class:normalizeClass(getActionIcon(log.action))},null,2)],2),createBaseVNode("div",_hoisted_12$3,[createBaseVNode("div",_hoisted_13$3,[createTextVNode(toDisplayString(getActionDescription(log.action,log.status))+" ",1),createBaseVNode("span",_hoisted_14$3,toDisplayString(log.file_id),1)])])]),createBaseVNode("div",_hoisted_15$3,toDisplayString(formatTime(log.created_at)),1)]),createBaseVNode("div",_hoisted_16$3,toDisplayString(unref(formatTaggingLog)(log,unref($t))),1)]))),128)),isLoadingMore.value?(openBlock(),createElementBlock("div",_hoisted_17$3,[_cache[4]||(_cache[4]=createBaseVNode("div",{class:"loading-spinner"},[createBaseVNode("i",{class:"fas fa-spinner fa-spin"})],-1)),createBaseVNode("span",_hoisted_18$3,toDisplayString(unref($t)("admin.tagging.logs.loading")),1)])):!hasMore.value&&__props.logs.length>0?(openBlock(),createElementBlock("div",_hoisted_19$2,[_cache[5]||(_cache[5]=createBaseVNode("i",{class:"fas fa-check-circle mr-2"},null,-1)),createTextVNode(" "+toDisplayString(unref($t)("admin.tagging.logs.allLoaded")),1)])):createCommentVNode("",!0)]))],544)])}}});const TaggingLogList=_export_sfc(_sfc_main$4,[["__scopeId","data-v-1d6f23ac"]]),_hoisted_1$3={class:"mb-3 flex items-center justify-between"},_hoisted_2$3={class:"module-title"},_hoisted_3$3={key:0,class:"flex gap-2"},_hoisted_4$3={class:"image-list-header grid-cols-table mb-2 grid gap-4 rounded border border-subtle px-4 py-2 text-xs font-medium",style:{background:"rgba(var(--color-background-800-rgb), 0.5)",color:"var(--color-content-muted)"}},_hoisted_5$3={class:"col-select flex items-center justify-center overflow-hidden"},_hoisted_6$3={class:"col-thumb flex items-center justify-center overflow-hidden"},_hoisted_7$3={class:"col-filename flex items-center overflow-hidden truncate"},_hoisted_8$3={class:"col-id flex items-center overflow-hidden truncate"},_hoisted_9$3={class:"col-dimension flex items-center overflow-hidden truncate"},_hoisted_10$2={class:"col-size flex items-center overflow-hidden truncate"},_hoisted_11$2={class:"col-format flex items-center overflow-hidden truncate"},_hoisted_12$2={class:"col-uploader flex items-center overflow-hidden truncate"},_hoisted_13$2={class:"col-status flex items-center overflow-hidden truncate"},_hoisted_14$2={class:"col-tries flex items-center overflow-hidden truncate"},_hoisted_15$2={class:"col-duration flex items-center overflow-hidden truncate"},_hoisted_16$2={class:"col-time flex items-center overflow-hidden truncate"},_hoisted_17$2={class:"col-actions flex items-center justify-center overflow-hidden"},_hoisted_18$2={key:0,class:"rounded border border-subtle p-3 py-6 text-center",style:{background:"rgba(var(--color-background-800-rgb), 0.3)",color:"var(--color-content-muted)"}},_hoisted_19$1={class:"text-xs"},_hoisted_20$1={key:1,class:"space-y-1"},_hoisted_21$1={class:"col-select flex items-center justify-center"},_hoisted_22$1={class:"col-index text-2xs text-content-content-muted flex items-center justify-center"},_hoisted_23$1={class:"col-thumb flex items-center justify-center"},_hoisted_24$1={class:"thumb-container overflow-hidden rounded border border-brand-300"},_hoisted_25$1={class:"col-filename flex items-center"},_hoisted_26$1=["title"],_hoisted_27$1={class:"col-id flex items-center"},_hoisted_28$1=["title"],_hoisted_29$1={class:"col-dimension flex items-center"},_hoisted_30$1=["title"],_hoisted_31$1={class:"col-size flex items-center"},_hoisted_32$1=["title"],_hoisted_33$1={class:"col-format flex items-center"},_hoisted_34$1=["title"],_hoisted_35$1={class:"col-uploader flex items-center"},_hoisted_36$1=["title"],_hoisted_37$1={class:"col-status flex items-center"},_hoisted_38$1={class:"col-tries flex items-center"},_hoisted_39$1=["title"],_hoisted_40={class:"col-duration flex items-center"},_hoisted_41=["title"],_hoisted_42={class:"col-time flex items-center"},_hoisted_43=["title"],_hoisted_44={class:"col-actions flex items-center justify-center"},_hoisted_45=["title","onClick"],_hoisted_46={key:2,class:"mt-4 flex justify-center"},_sfc_main$3=defineComponent({__name:"TaggingFileList",props:{images:{},isLoading:{type:Boolean},total:{},currentPage:{},pageSize:{},processing:{type:Boolean},selectedIds:{}},emits:["page-change","page-size-change","toggle-select","toggle-select-all","ignore-selected","unignore-selected","retry"],setup(__props,{emit:__emit}){const{$t}=useTexts(),props=__props,imageLoadingStates=ref({}),emit=__emit;function debounce(fn,delay){let timer=null;return function(...args){timer&&clearTimeout(timer),timer=setTimeout(()=>{fn.apply(this,args),timer=null},delay)}}const isPageAllSelected=computed(()=>!props.images||props.images.length===0?!1:props.images.every(img=>props.selectedIds.includes(img.id))),toggleSelectAll=checked=>{emit("toggle-select-all",checked)},tableContainer=ref(null),columnWidths=ref({select:32,index:40,thumb:70,filename:0,id:0,dimension:0,size:0,format:0,uploader:0,status:0,tries:0,duration:0,time:0,actions:40}),columnWeights={filename:4,id:2.5,dimension:1.5,size:1,format:1,uploader:1.2,status:1.2,tries:1,duration:1.5,time:1.8},calculateColumnWidths=()=>{if(!tableContainer.value)return;const totalWidth=tableContainer.value.clientWidth;if(totalWidth<=0)return;const paddingWidth=32,fixedWidth=columnWidths.value.select+columnWidths.value.index+columnWidths.value.thumb+columnWidths.value.actions,gapWidth=13*16,availableWidth=totalWidth-fixedWidth-gapWidth-paddingWidth;if(availableWidth<=0)return;const totalWeight=Object.values(columnWeights).reduce((sum,weight)=>sum+weight,0),tempWidths={};tempWidths.filename=Math.floor(availableWidth*(columnWeights.filename/totalWeight)),tempWidths.id=Math.floor(availableWidth*(columnWeights.id/totalWeight)),tempWidths.dimension=Math.floor(availableWidth*(columnWeights.dimension/totalWeight)),tempWidths.size=Math.floor(availableWidth*(columnWeights.size/totalWeight)),tempWidths.format=Math.floor(availableWidth*(columnWeights.format/totalWeight)),tempWidths.uploader=Math.floor(availableWidth*(columnWeights.uploader/totalWeight)),tempWidths.status=Math.floor(availableWidth*(columnWeights.status/totalWeight)),tempWidths.tries=Math.floor(availableWidth*(columnWeights.tries/totalWeight)),tempWidths.duration=Math.floor(availableWidth*(columnWeights.duration/totalWeight)),tempWidths.time=Math.floor(availableWidth*(columnWeights.time/totalWeight));const allocatedWidth=Object.values(tempWidths).reduce((sum,width)=>sum+width,0);if(allocatedWidth>availableWidth){const scaleFactor=availableWidth/allocatedWidth;Object.keys(tempWidths).forEach(key=>{tempWidths[key]=Math.floor(tempWidths[key]*scaleFactor)})}const newAllocatedWidth=Object.values(tempWidths).reduce((sum,width)=>sum+width,0),remainingWidth=availableWidth-newAllocatedWidth;remainingWidth>0&&(tempWidths.filename+=remainingWidth),Object.keys(tempWidths).forEach(key=>{columnWidths.value[key]=tempWidths[key]}),tableContainer.value&&Object.entries(columnWidths.value).forEach(([key,value])=>{tableContainer.value?.style.setProperty(`--col-${key}-width`,`${value}px`)})},handleResize=debounce(()=>{calculateColumnWidths()},200);onMounted(()=>{window.addEventListener("resize",handleResize),setTimeout(()=>{calculateColumnWidths(),setTimeout(()=>{calculateColumnWidths()},100)},0)}),onUnmounted(()=>{window.removeEventListener("resize",handleResize)});const formatTime=timeString2=>{try{return new Date(timeString2).toLocaleString(getCurrentLocale(),{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})}catch{return timeString2}},formatFileSize=bytes=>{if(!bytes)return $t("admin.tagging.fileList.unknown");const units=["B","KB","MB","GB"];let size=bytes,unitIndex=0;for(;size>=1024&&unitIndex<units.length-1;)size/=1024,unitIndex++;return`${size.toFixed(1)} ${units[unitIndex]}`},getStatusText=status=>$t(`admin.tagging.status.${status}`)||status,getStatusClass=status=>({none:"bg-background-600 text-content-heading border border-default",pending:"bg-error-200 text-error-500 border border-error-500",done:"bg-green-900/30 text-green-400 border border-green-500/50",failed:"bg-red-900/30 text-red-400 border border-red-500/50",skipped:"bg-background-500 text-content-muted border border-default",ignored:"bg-background-700 text-content-content-muted border border-subtle"})[status]||"",timeString=timeString2=>{try{return new Date(timeString2).toLocaleString(getCurrentLocale(),{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{return timeString2}};return(_ctx,_cache)=>{const _component_CyberButton=resolveComponent("CyberButton"),_component_CyberCheckbox=resolveComponent("CyberCheckbox"),_component_CyberSkeleton=__unplugin_components_0,_component_CyberFile=resolveComponent("CyberFile"),_component_CyberPagination=resolveComponent("CyberPagination"),_directive_loading=resolveDirective("loading");return openBlock(),createElementBlock("div",{ref_key:"tableContainer",ref:tableContainer,class:"tagging-image-list"},[createBaseVNode("div",_hoisted_1$3,[createBaseVNode("h2",_hoisted_2$3,[_cache[6]||(_cache[6]=createBaseVNode("i",{class:"fas fa-clipboard-list mr-2"},null,-1)),createTextVNode(toDisplayString(unref($t)("admin.tagging.fileList.title")),1)]),__props.selectedIds.length>0?(openBlock(),createElementBlock("div",_hoisted_3$3,[createVNode(_component_CyberButton,{type:"secondary",size:"small",onClick:_cache[0]||(_cache[0]=$event=>_ctx.$emit("ignore-selected",unref($t)("admin.tagging.actions.ignore")))},{default:withCtx(()=>[_cache[7]||(_cache[7]=createBaseVNode("i",{class:"fas fa-ban mr-1.5"},null,-1)),createTextVNode(toDisplayString(unref($t)("admin.tagging.actions.ignore"))+"（"+toDisplayString(__props.selectedIds.length)+"） ",1)]),_:1}),createVNode(_component_CyberButton,{type:"primary",size:"small",onClick:_cache[1]||(_cache[1]=$event=>_ctx.$emit("unignore-selected"))},{default:withCtx(()=>[_cache[8]||(_cache[8]=createBaseVNode("i",{class:"fas fa-undo mr-1.5"},null,-1)),createTextVNode(toDisplayString(unref($t)("admin.tagging.actions.unignore"))+"（"+toDisplayString(__props.selectedIds.length)+"） ",1)]),_:1})])):createCommentVNode("",!0)]),createBaseVNode("div",_hoisted_4$3,[createBaseVNode("div",_hoisted_5$3,[createVNode(_component_CyberCheckbox,{"model-value":isPageAllSelected.value,"onUpdate:modelValue":toggleSelectAll},null,8,["model-value"])]),_cache[9]||(_cache[9]=createBaseVNode("div",{class:"col-index flex items-center justify-center overflow-hidden"},"#",-1)),createBaseVNode("div",_hoisted_6$3,toDisplayString(unref($t)("admin.tagging.fileList.headers.thumbnail")),1),createBaseVNode("div",_hoisted_7$3,toDisplayString(unref($t)("admin.tagging.fileList.headers.filename")),1),createBaseVNode("div",_hoisted_8$3,toDisplayString(unref($t)("admin.tagging.fileList.headers.id")),1),createBaseVNode("div",_hoisted_9$3,toDisplayString(unref($t)("admin.tagging.fileList.headers.dimension")),1),createBaseVNode("div",_hoisted_10$2,toDisplayString(unref($t)("admin.tagging.fileList.headers.size")),1),createBaseVNode("div",_hoisted_11$2,toDisplayString(unref($t)("admin.tagging.fileList.headers.format")),1),createBaseVNode("div",_hoisted_12$2,toDisplayString(unref($t)("admin.tagging.fileList.headers.uploader")),1),createBaseVNode("div",_hoisted_13$2,toDisplayString(unref($t)("admin.tagging.fileList.headers.status")),1),createBaseVNode("div",_hoisted_14$2,toDisplayString(unref($t)("admin.tagging.fileList.headers.tries")),1),createBaseVNode("div",_hoisted_15$2,toDisplayString(unref($t)("admin.tagging.fileList.headers.duration")),1),createBaseVNode("div",_hoisted_16$2,toDisplayString(unref($t)("admin.tagging.fileList.headers.time")),1),createBaseVNode("div",_hoisted_17$2,toDisplayString(unref($t)("admin.tagging.fileList.headers.actions")),1)]),createVNode(_component_CyberSkeleton,{type:"table",count:6,loading:__props.isLoading},null,8,["loading"]),!__props.isLoading&&__props.images.length===0?(openBlock(),createElementBlock("div",_hoisted_18$2,[_cache[10]||(_cache[10]=createBaseVNode("i",{class:"fas fa-search mb-2 text-2xl text-brand-500"},null,-1)),createBaseVNode("p",_hoisted_19$1,toDisplayString(unref($t)("admin.tagging.fileList.noFiles")),1)])):createCommentVNode("",!0),!__props.isLoading&&__props.images.length>0?(openBlock(),createElementBlock("div",_hoisted_20$1,[(openBlock(!0),createElementBlock(Fragment,null,renderList(__props.images,(image,index2)=>(openBlock(),createElementBlock("div",{key:image.id,class:"image-list-item grid-cols-table grid gap-4 rounded border border-subtle px-4 py-2 transition-all duration-300",style:{background:"rgba(var(--color-background-800-rgb), 0.3)"},onMouseenter:_cache[2]||(_cache[2]=$event=>$event.currentTarget.style.background="rgba(var(--color-background-800-rgb), 0.5)"),onMouseleave:_cache[3]||(_cache[3]=$event=>$event.currentTarget.style.background="rgba(var(--color-background-800-rgb), 0.3)")},[createBaseVNode("div",_hoisted_21$1,[createVNode(_component_CyberCheckbox,{"model-value":__props.selectedIds.includes(image.id),"onUpdate:modelValue":()=>_ctx.$emit("toggle-select",image.id)},null,8,["model-value","onUpdate:modelValue"])]),createBaseVNode("div",_hoisted_22$1,toDisplayString((__props.currentPage-1)*__props.pageSize+index2+1),1),createBaseVNode("div",_hoisted_23$1,[withDirectives((openBlock(),createElementBlock("div",_hoisted_24$1,[createVNode(_component_CyberFile,{src:image.full_thumb_url,alt:image.original_name,class:"h-auto max-h-10 w-full","fit-mode":"cover","retry-count":2,"is-nsfw":image.is_nsfw,onLoading:$event=>imageLoadingStates.value[image.id]=$event},null,8,["src","alt","is-nsfw","onLoading"])])),[[_directive_loading,imageLoadingStates.value[image.id]]])]),createBaseVNode("div",_hoisted_25$1,[createBaseVNode("div",{class:"text-2xs w-full truncate text-content-heading",title:image.original_name},toDisplayString(image.original_name),9,_hoisted_26$1)]),createBaseVNode("div",_hoisted_27$1,[createBaseVNode("div",{class:"text-2xs w-full truncate text-content",title:image.id},toDisplayString(image.id),9,_hoisted_28$1)]),createBaseVNode("div",_hoisted_29$1,[createBaseVNode("div",{class:"text-2xs w-full truncate text-content-heading",title:`${image.width||0}x${image.height||0}`},toDisplayString(image.width||0)+"x"+toDisplayString(image.height||0),9,_hoisted_30$1)]),createBaseVNode("div",_hoisted_31$1,[createBaseVNode("div",{class:"text-2xs w-full truncate text-content",title:formatFileSize(image.size)},toDisplayString(formatFileSize(image.size)),9,_hoisted_32$1)]),createBaseVNode("div",_hoisted_33$1,[createBaseVNode("div",{class:"text-2xs w-full truncate text-content",title:image.format||unref($t)("admin.tagging.fileList.unknown")},toDisplayString(image.format||unref($t)("admin.tagging.fileList.unknown")),9,_hoisted_34$1)]),createBaseVNode("div",_hoisted_35$1,[createBaseVNode("div",{class:"text-2xs w-full truncate text-content",title:`ID ${image.user_id}`},"ID "+toDisplayString(image.user_id),9,_hoisted_36$1)]),createBaseVNode("div",_hoisted_37$1,[createBaseVNode("span",{class:normalizeClass(["status-badge text-2xs whitespace-nowrap rounded-full px-1.5 py-0.5",getStatusClass(image.ai_tagging_status)])},toDisplayString(getStatusText(image.ai_tagging_status)),3)]),createBaseVNode("div",_hoisted_38$1,[createBaseVNode("div",{class:"text-2xs w-full truncate text-content",title:`${image.ai_tagging_tries}`},toDisplayString(image.ai_tagging_tries),9,_hoisted_39$1)]),createBaseVNode("div",_hoisted_40,[createBaseVNode("div",{class:"text-2xs w-full truncate text-content",title:image.ai_http_duration_formatted||"-"},[image.ai_http_duration_formatted?(openBlock(),createElementBlock(Fragment,{key:0},[_cache[11]||(_cache[11]=createBaseVNode("span",{class:"text-brand-400"},"HTTP:",-1)),createTextVNode(" "+toDisplayString(image.ai_http_duration_formatted),1)],64)):(openBlock(),createElementBlock(Fragment,{key:1},[createTextVNode("-")],64))],8,_hoisted_41)]),createBaseVNode("div",_hoisted_42,[createBaseVNode("div",{class:"text-2xs w-full truncate text-content",title:timeString(image.updated_at)},toDisplayString(formatTime(image.updated_at)),9,_hoisted_43)]),createBaseVNode("div",_hoisted_44,[image.ai_tagging_status==="failed"?(openBlock(),createElementBlock("button",{key:0,class:"retry-button",title:unref($t)("admin.tagging.fileList.retryTooltip"),onClick:$event=>_ctx.$emit("retry",[image.id])},[..._cache[12]||(_cache[12]=[createBaseVNode("i",{class:"fas fa-redo"},null,-1)])],8,_hoisted_45)):createCommentVNode("",!0)])],32))),128))])):createCommentVNode("",!0),!__props.isLoading&&Math.ceil(__props.total/__props.pageSize)>1?(openBlock(),createElementBlock("div",_hoisted_46,[createVNode(_component_CyberPagination,{"current-page":__props.currentPage,"total-pages":Math.ceil(__props.total/__props.pageSize),total:__props.total,"page-size":__props.pageSize,"show-page-size-selector":!0,"show-quick-jumper":!0,class:"text-xs","onUpdate:currentPage":_cache[4]||(_cache[4]=$event=>_ctx.$emit("page-change",$event)),"onUpdate:pageSize":_cache[5]||(_cache[5]=$event=>_ctx.$emit("page-size-change",$event))},null,8,["current-page","total-pages","total","page-size"])])):createCommentVNode("",!0)],512)}}});const TaggingFileList=_export_sfc(_sfc_main$3,[["__scopeId","data-v-473ed95b"]]),_hoisted_1$2={class:"ai-queue-status-card"},_hoisted_2$2={key:0,class:"diagnosis-banner"},_hoisted_3$2={class:"diagnosis-header"},_hoisted_4$2={class:"diagnosis-title"},_hoisted_5$2={class:"diagnosis-content"},_hoisted_6$2={class:"diagnosis-section"},_hoisted_7$2={class:"section-label"},_hoisted_8$2={class:"issue-list"},_hoisted_9$2={class:"diagnosis-section"},_hoisted_10$1={class:"section-label"},_hoisted_11$1={class:"recommendation-list"},_hoisted_12$1={class:"diagnosis-action-hint"},_hoisted_13$1={key:1,class:"warning-banner"},_hoisted_14$1={class:"card-info-bar"},_hoisted_15$1={class:"info-items"},_hoisted_16$1={class:"info-item connection-status"},_hoisted_17$1={class:"status-text"},_hoisted_18$1={class:"info-item last-update"},_hoisted_19={class:"update-time"},_hoisted_20={class:"status-grid"},_hoisted_21={key:0,class:"paused-banner"},_hoisted_22={class:"status-content"},_hoisted_23={class:"status-label"},_hoisted_24={class:"status-count"},_hoisted_25={class:"status-content"},_hoisted_26={class:"status-label"},_hoisted_27={class:"status-count"},_hoisted_28={class:"status-content"},_hoisted_29={class:"status-label"},_hoisted_30={class:"status-count"},_hoisted_31={class:"status-content"},_hoisted_32={class:"status-label"},_hoisted_33={class:"status-count"},_hoisted_34={class:"status-content"},_hoisted_35={class:"status-label"},_hoisted_36={class:"status-count"},_hoisted_37={class:"status-content"},_hoisted_38={class:"status-label"},_hoisted_39={class:"status-count"},_sfc_main$2=defineComponent({__name:"TaggingQueueStatus",props:{selectedStatus:{}},emits:["select"],setup(__props,{expose:__expose,emit:__emit}){const{$t}=useTexts(),props=__props,emit=__emit,webSocketStore=useWebSocketStore(),fallbackQueueStats=ref(null),lastUpdate=ref(new Date),isLoading=ref(!1),useWebSocketMode=ref(!0),diagnosis=ref(null),queueStats=computed(()=>webSocketStore.queueStats||fallbackQueueStats.value);computed(()=>{const data=queueStats.value;return!data||!data.queue_stats_ext?{queued:0,processing:0,delayed:0,dlq:0}:data.queue_stats_ext});const runtime=computed(()=>{const data=queueStats.value;return data&&data.runtime||{}});computed(()=>{const active=runtime.value?.active_workers??queueStats.value?.config?.current_concurrency??0,max=runtime.value?.configured_concurrency??queueStats.value?.config?.max_concurrency??0;return max?Math.min(100,Math.round(active/max*100)):0});const lastUpdatedText=computed(()=>{const updateTime=useWebSocketMode.value?webSocketStore.lastUpdated:lastUpdate.value,diff=new Date().getTime()-updateTime.getTime(),seconds=Math.floor(diff/1e3);if(seconds<60)return $t("admin.tagging.queue.secondsAgo").replace("{seconds}",String(seconds));const minutes=Math.floor(seconds/60);return $t("admin.tagging.queue.minutesAgo").replace("{minutes}",String(minutes))}),isConnected=computed(()=>webSocketStore.isConnected),connectionStatus=computed(()=>webSocketStore.connectionStatus),connectionStatusText=computed(()=>useWebSocketMode.value?webSocketStore.connectionStatusText:$t("admin.tagging.queue.pollingMode"));computed(()=>useWebSocketMode.value&&webSocketStore.queueStats?webSocketStore.queueCompletionRate:!queueStats.value||queueStats.value.queue_stats.total_count===0?0:Math.round(queueStats.value.queue_stats.done_count/queueStats.value.queue_stats.total_count*100));const hasQueueActivity=computed(()=>{if(!queueStats.value)return!1;const stats=queueStats.value.queue_stats,{config}=queueStats.value;return config.current_concurrency>0||stats.pending_count>0||stats.none_count>0}),paused=computed(()=>diagnosis.value?diagnosis.value.paused:useWebSocketMode.value&&webSocketStore.queueStats?!!webSocketStore.queueStats?.config?.paused:!!queueStats.value?.config?.paused),queueInitialized=computed(()=>diagnosis.value?.queue_initialized??!0),getStatusText=()=>queueInitialized.value?paused.value?$t("admin.dashboard.aiServices.statusDegraded"):$t("admin.dashboard.aiServices.statusNormal"):$t("admin.dashboard.aiServices.statusDown"),getStatusColor=()=>queueInitialized.value?paused.value?"text-warning-500":"text-success-500":"text-error-500";computed(()=>useWebSocketMode.value&&webSocketStore.queueStats?webSocketStore.queueStats?.config?.recent_failures||0:queueStats.value?.config?.recent_failures||0),computed(()=>useWebSocketMode.value&&webSocketStore.queueStats?webSocketStore.queueStats?.config?.queue_length||0:queueStats.value?.config?.queue_length||0);const loadQueueStats=async()=>{if(!isLoading.value){isLoading.value=!0;try{const result=await getQueueStats();result.success&&(fallbackQueueStats.value=result.data,useWebSocketMode.value||(lastUpdate.value=new Date))}catch{fallbackQueueStats.value=null}finally{isLoading.value=!1}}},loadDiagnosis=async()=>{try{const result=await getTaggingDiagnosis();result.success&&(diagnosis.value=result.data)}catch{}};onMounted(async()=>{await Promise.all([loadQueueStats(),loadDiagnosis()])});const selectStatus=status=>{const mappedStatus={total:"",none:"none",pending:"pending",done:"done",failed:"failed",ignored:"ignored"}[status]||status;status==="total"?emit("select",""):emit("select",mappedStatus===props.selectedStatus?"":mappedStatus)},getStatusItemClass=status=>{const mappedStatus={total:"",none:"none",pending:"pending",done:"done",failed:"failed",ignored:"ignored"}[status],isSelected=props.selectedStatus===mappedStatus,baseClass="status-item";return isSelected?`${baseClass} status-item-selected`:baseClass};return __expose({refresh:loadQueueStats,hasActivity:hasQueueActivity,isConnected:webSocketStore.isConnected,connectionStatus:webSocketStore.connectionStatusText}),(_ctx,_cache)=>(openBlock(),createElementBlock("div",_hoisted_1$2,[diagnosis.value&&diagnosis.value.config_issues.length>0?(openBlock(),createElementBlock("div",_hoisted_2$2,[createBaseVNode("div",_hoisted_3$2,[_cache[6]||(_cache[6]=createBaseVNode("div",{class:"diagnosis-icon"},[createBaseVNode("i",{class:"fas fa-exclamation-triangle"})],-1)),createBaseVNode("div",_hoisted_4$2,toDisplayString(unref($t)("admin.tagging.queueDiagnosis.title")),1)]),createBaseVNode("div",_hoisted_5$2,[createBaseVNode("div",_hoisted_6$2,[createBaseVNode("div",_hoisted_7$2,[_cache[7]||(_cache[7]=createBaseVNode("i",{class:"fas fa-bug mr-1.5"},null,-1)),createTextVNode(" "+toDisplayString(unref($t)("admin.tagging.queueDiagnosis.issuesFound")),1)]),createBaseVNode("ul",_hoisted_8$2,[(openBlock(!0),createElementBlock(Fragment,null,renderList(diagnosis.value.config_issues,issue=>(openBlock(),createElementBlock("li",{key:issue},[_cache[8]||(_cache[8]=createBaseVNode("i",{class:"fas fa-circle mr-2 text-xs"},null,-1)),createBaseVNode("span",null,toDisplayString(issue),1)]))),128))])]),createBaseVNode("div",_hoisted_9$2,[createBaseVNode("div",_hoisted_10$1,[_cache[9]||(_cache[9]=createBaseVNode("i",{class:"fas fa-lightbulb mr-1.5"},null,-1)),createTextVNode(" "+toDisplayString(unref($t)("admin.tagging.queueDiagnosis.recommendations")),1)]),createBaseVNode("ul",_hoisted_11$1,[(openBlock(!0),createElementBlock(Fragment,null,renderList(diagnosis.value.recommendations,rec=>(openBlock(),createElementBlock("li",{key:rec},[_cache[10]||(_cache[10]=createBaseVNode("i",{class:"fas fa-arrow-right mr-2 text-xs"},null,-1)),createBaseVNode("span",null,toDisplayString(rec),1)]))),128))])])]),createBaseVNode("div",_hoisted_12$1,[_cache[11]||(_cache[11]=createBaseVNode("i",{class:"fas fa-info-circle mr-2"},null,-1)),createBaseVNode("span",null,toDisplayString(unref($t)("admin.tagging.queueDiagnosis.hint")),1)])])):createCommentVNode("",!0),diagnosis.value&&!diagnosis.value.queue_initialized?(openBlock(),createElementBlock("div",_hoisted_13$1,[_cache[12]||(_cache[12]=createBaseVNode("i",{class:"fas fa-exclamation-circle mr-2"},null,-1)),createBaseVNode("span",null,toDisplayString(unref($t)("admin.dashboard.aiServices.statusDown")),1)])):createCommentVNode("",!0),createBaseVNode("div",_hoisted_14$1,[createBaseVNode("div",_hoisted_15$1,[createBaseVNode("span",{class:normalizeClass(["info-item",getStatusColor()])},toDisplayString(getStatusText()),3),createBaseVNode("div",_hoisted_16$1,[createBaseVNode("i",{class:normalizeClass({"fas fa-wifi":isConnected.value&&useWebSocketMode.value,"fas fa-wifi text-green-500":isConnected.value&&useWebSocketMode.value,"fas fa-exclamation-triangle text-yellow-500":connectionStatus.value==="reconnecting","fas fa-times-circle text-red-500":connectionStatus.value==="error"||connectionStatus.value==="disconnected","fas fa-clock":!useWebSocketMode.value})},null,2),createBaseVNode("span",_hoisted_17$1,toDisplayString(connectionStatusText.value),1)]),createBaseVNode("div",_hoisted_18$1,[_cache[13]||(_cache[13]=createBaseVNode("i",{class:"fas fa-clock mr-1"},null,-1)),createBaseVNode("span",_hoisted_19,toDisplayString(lastUpdatedText.value),1)])])]),createBaseVNode("div",_hoisted_20,[paused.value?(openBlock(),createElementBlock("div",_hoisted_21,[_cache[14]||(_cache[14]=createBaseVNode("i",{class:"fas fa-pause-circle mr-2"},null,-1)),createTextVNode(" "+toDisplayString(unref($t)("admin.tagging.hints.queuePaused")),1)])):createCommentVNode("",!0),createBaseVNode("div",{class:normalizeClass(getStatusItemClass("total")),onClick:_cache[0]||(_cache[0]=$event=>selectStatus("total"))},[_cache[15]||(_cache[15]=createBaseVNode("div",{class:"status-icon icon-all"},[createBaseVNode("i",{class:"fas fa-list"})],-1)),createBaseVNode("div",_hoisted_22,[createBaseVNode("div",_hoisted_23,toDisplayString(unref($t)("admin.tagging.status.all")),1),createBaseVNode("div",_hoisted_24,toDisplayString(queueStats.value?.queue_stats.total_count||0),1)])],2),createBaseVNode("div",{class:normalizeClass(getStatusItemClass("none")),onClick:_cache[1]||(_cache[1]=$event=>selectStatus("none"))},[_cache[16]||(_cache[16]=createBaseVNode("div",{class:"status-icon icon-pending"},[createBaseVNode("i",{class:"fas fa-clock"})],-1)),createBaseVNode("div",_hoisted_25,[createBaseVNode("div",_hoisted_26,toDisplayString(unref($t)("admin.tagging.status.none")),1),createBaseVNode("div",_hoisted_27,toDisplayString(queueStats.value?.queue_stats.none_count||0),1)])],2),createBaseVNode("div",{class:normalizeClass(getStatusItemClass("pending")),onClick:_cache[2]||(_cache[2]=$event=>selectStatus("pending"))},[_cache[17]||(_cache[17]=createBaseVNode("div",{class:"status-icon icon-running"},[createBaseVNode("i",{class:"fas fa-spinner"})],-1)),createBaseVNode("div",_hoisted_28,[createBaseVNode("div",_hoisted_29,toDisplayString(unref($t)("admin.tagging.status.pending")),1),createBaseVNode("div",_hoisted_30,toDisplayString(queueStats.value?.queue_stats.pending_count||0),1)])],2),createBaseVNode("div",{class:normalizeClass(getStatusItemClass("done")),onClick:_cache[3]||(_cache[3]=$event=>selectStatus("done"))},[_cache[18]||(_cache[18]=createBaseVNode("div",{class:"status-icon icon-completed"},[createBaseVNode("i",{class:"fas fa-check-circle"})],-1)),createBaseVNode("div",_hoisted_31,[createBaseVNode("div",_hoisted_32,toDisplayString(unref($t)("admin.tagging.status.done")),1),createBaseVNode("div",_hoisted_33,toDisplayString(queueStats.value?.queue_stats.done_count||0),1)])],2),createBaseVNode("div",{class:normalizeClass(getStatusItemClass("failed")),onClick:_cache[4]||(_cache[4]=$event=>selectStatus("failed"))},[_cache[19]||(_cache[19]=createBaseVNode("div",{class:"status-icon icon-failed"},[createBaseVNode("i",{class:"fas fa-exclamation-circle"})],-1)),createBaseVNode("div",_hoisted_34,[createBaseVNode("div",_hoisted_35,toDisplayString(unref($t)("admin.tagging.status.failed")),1),createBaseVNode("div",_hoisted_36,toDisplayString(queueStats.value?.queue_stats.failed_count||0),1)])],2),createBaseVNode("div",{class:normalizeClass(getStatusItemClass("ignored")),onClick:_cache[5]||(_cache[5]=$event=>selectStatus("ignored"))},[_cache[20]||(_cache[20]=createBaseVNode("div",{class:"status-icon icon-ignored"},[createBaseVNode("i",{class:"fas fa-ban"})],-1)),createBaseVNode("div",_hoisted_37,[createBaseVNode("div",_hoisted_38,toDisplayString(unref($t)("admin.tagging.status.ignored")),1),createBaseVNode("div",_hoisted_39,toDisplayString(queueStats.value?.queue_stats.ignored_count||0),1)])],2)])]))}});const TaggingQueueStatus=_export_sfc(_sfc_main$2,[["__scopeId","data-v-34a5d301"]]),_hoisted_1$1={class:"filter-panel"},_hoisted_2$1={class:"filter-grid"},_hoisted_3$1={class:"filter-item"},_hoisted_4$1={class:"filter-label"},_hoisted_5$1={class:"filter-item"},_hoisted_6$1={class:"filter-label"},_hoisted_7$1={class:"filter-item"},_hoisted_8$1={class:"filter-label"},_hoisted_9$1={class:"filter-actions"},_sfc_main$1=defineComponent({__name:"TaggingFilterPanel",props:{initialFilters:{default:()=>({})}},emits:["filter"],setup(__props,{emit:__emit}){const{$t}=useTexts(),props=__props,emit=__emit,statusOptions=computed(()=>[{value:"",label:$t("admin.tagging.status.all")},{value:"none",label:$t("admin.tagging.status.none")},{value:"pending",label:$t("admin.tagging.status.pending")},{value:"done",label:$t("admin.tagging.status.done")},{value:"failed",label:$t("admin.tagging.status.failed")},{value:"skipped",label:$t("admin.tagging.status.skipped")},{value:"ignored",label:$t("admin.tagging.status.ignored")}]),orderByOptions=computed(()=>[{value:"created_at",label:$t("admin.tagging.filter.createdAt")},{value:"updated_at",label:$t("admin.tagging.filter.updatedAt")},{value:"ai_tagging_tries",label:$t("admin.tagging.filter.tries")},{value:"ai_tagging_status",label:$t("admin.tagging.filter.taggingStatus")}]),orderOptions=computed(()=>[{value:"desc",label:$t("admin.tagging.filter.desc")},{value:"asc",label:$t("admin.tagging.filter.asc")}]),formState=reactive({status:"",page:1,limit:20,order_by:"created_at",order:"desc",...props.initialFilters});watch(()=>props.initialFilters,newVal=>{newVal&&Object.assign(formState,newVal)},{deep:!0});const applyFilter=()=>{emit("filter",{...formState})},resetForm=()=>{Object.assign(formState,{status:"",page:1,limit:20,order_by:"created_at",order:"desc"}),emit("filter",{...formState})};return(_ctx,_cache)=>{const _component_CyberDropdown=resolveComponent("CyberDropdown"),_component_CyberButton=resolveComponent("CyberButton");return openBlock(),createElementBlock("div",_hoisted_1$1,[createBaseVNode("div",_hoisted_2$1,[createBaseVNode("div",_hoisted_3$1,[createBaseVNode("label",_hoisted_4$1,toDisplayString(unref($t)("admin.tagging.filter.status")),1),createVNode(_component_CyberDropdown,{modelValue:formState.status,"onUpdate:modelValue":_cache[0]||(_cache[0]=$event=>formState.status=$event),class:"w-full",options:unref(statusOptions)},null,8,["modelValue","options"])]),createBaseVNode("div",_hoisted_5$1,[createBaseVNode("label",_hoisted_6$1,toDisplayString(unref($t)("admin.tagging.filter.orderBy")),1),createVNode(_component_CyberDropdown,{modelValue:formState.order_by,"onUpdate:modelValue":_cache[1]||(_cache[1]=$event=>formState.order_by=$event),class:"w-full",options:unref(orderByOptions)},null,8,["modelValue","options"])]),createBaseVNode("div",_hoisted_7$1,[createBaseVNode("label",_hoisted_8$1,toDisplayString(unref($t)("admin.tagging.filter.order")),1),createVNode(_component_CyberDropdown,{modelValue:formState.order,"onUpdate:modelValue":_cache[2]||(_cache[2]=$event=>formState.order=$event),class:"w-full",options:unref(orderOptions)},null,8,["modelValue","options"])]),createBaseVNode("div",_hoisted_9$1,[createVNode(_component_CyberButton,{type:"primary",class:"apply-btn",onClick:applyFilter},{default:withCtx(()=>[_cache[3]||(_cache[3]=createBaseVNode("i",{class:"fas fa-check mr-1.5"},null,-1)),createTextVNode(toDisplayString(unref($t)("admin.tagging.filter.apply")),1)]),_:1}),createVNode(_component_CyberButton,{type:"text",class:"reset-btn",onClick:resetForm},{default:withCtx(()=>[_cache[4]||(_cache[4]=createBaseVNode("i",{class:"fas fa-sync-alt mr-1.5"},null,-1)),createTextVNode(toDisplayString(unref($t)("admin.tagging.filter.reset")),1)]),_:1})])])])}}});const TaggingFilterPanel=_export_sfc(_sfc_main$1,[["__scopeId","data-v-3b0e9cbb"]]),_hoisted_1={class:"admin-tagging-page admin-page-container"},_hoisted_2={key:0},_hoisted_3={class:"flex items-center gap-2"},_hoisted_4={class:"text-xs"},_hoisted_5={class:"flex items-center gap-2"},_hoisted_6={class:"whitespace-nowrap text-xs"},_hoisted_7={class:"w-6 text-center text-xs"},_hoisted_8={class:"tagging-content admin-content-wrapper"},_hoisted_9={class:"module-wrapper"},_hoisted_10={class:"module-header"},_hoisted_11={class:"module-title"},_hoisted_12={class:"module-content"},_hoisted_13={key:0,class:"filter-section"},_hoisted_14={class:"image-list-section"},_hoisted_15={class:"module-wrapper module-wrapper-last"},_hoisted_16={class:"module-header"},_hoisted_17={class:"module-title"},_hoisted_18={class:"module-content"},_sfc_main=defineComponent({__name:"index",setup(__props){const{$t}=useTexts(),toast=useToast(),webSocketStore=useWebSocketStore(),isLoading=ref(!1),isProcessing=ref(!1),showSkeleton=ref(!1),logs=ref([]),logPagination=ref({page:1,limit:20,total:0}),selectedFileId=ref(""),images=ref([]),total=ref(0),currentPage=ref(1),pageSize=ref(10),selectedIds=ref([]);computed(()=>selectedIds.value.length);const showFilter=ref(!1),filters=reactive({status:"",page:1,limit:10,order_by:"updated_at",order:"desc"}),autoEnabled=ref(!0),updatingAuto=ref(!1),concurrency=ref(0),fallbackStats=ref([]),stats=computed(()=>{if(webSocketStore.queueStats){const queueStats=webSocketStore.queueStats.queue_stats;return[{status:"none",count:queueStats.none_count||0},{status:"pending",count:queueStats.pending_count||0},{status:"done",count:queueStats.done_count||0},{status:"failed",count:queueStats.failed_count||0},{status:"ignored",count:queueStats.ignored_count||0},{status:"skipped",count:0}]}return fallbackStats.value}),loadTaggingStatus=async()=>{try{isLoading.value=!0,showSkeleton.value=!0;const result=await getTaggingStatusList({...filters,page:currentPage.value});result.success&&(images.value=result.data?.data||[],total.value=result.data?.total||0)}catch(e){toast.error(e?.message||$t("admin.tagging.messages.loadFailed"))}finally{isLoading.value=!1,showSkeleton.value=!1}},loadFallbackTaggingStats=async()=>{try{const result=await getTaggingStats();if(result.success){const{data}=result;(!webSocketStore.isConnected||!webSocketStore.queueStats)&&(fallbackStats.value=data?.status_stats||[])}}catch(error){toast.error(error.message)}},loadTaggingLogs=async(fileID="",page=1,append=!1)=>{try{const result=await getTaggingLogs({file_id:fileID,page,limit:logPagination.value.limit});if(result.success&&result.data){const{logs:newLogs,pagination}=result.data;append?logs.value=[...logs.value,...newLogs]:logs.value=newLogs,logPagination.value={page:pagination.page,limit:pagination.limit,total:pagination.total}}}catch(error){toast.error(error?.message||$t("admin.tagging.messages.loadLogsFailed"))}},handleLogLoadMore=async()=>{const nextPage=logPagination.value.page+1;await loadTaggingLogs(selectedFileId.value,nextPage,!0)},handleLogRefresh=async()=>{logPagination.value.page=1,await loadTaggingLogs(selectedFileId.value,1,!1)},handleClearLogFilter=async()=>{selectedFileId.value="",logPagination.value.page=1,await loadTaggingLogs("",1,!1)},reloadData=async()=>{await Promise.all([loadTaggingStatus(),loadFallbackTaggingStats(),loadTaggingLogs()])},loadAiSettings=async()=>{try{const{data}=await getSettings({group:"ai"}),map=Object.fromEntries((data.settings||[]).map(s=>[s.key,s.value]));typeof map.ai_concurrency=="number"&&(concurrency.value=map.ai_concurrency),typeof map.ai_auto_processing_enabled=="boolean"&&(autoEnabled.value=map.ai_auto_processing_enabled)}catch{}},handleStatusSelect=status=>{filters.status=status,currentPage.value=1,selectedIds.value=[],loadTaggingStatus()},handleFilter=newFilters=>{Object.assign(filters,newFilters),currentPage.value=1,selectedIds.value=[],loadTaggingStatus(),showFilter.value=!1},handlePageChange=page=>{currentPage.value=page,loadTaggingStatus()},handlePageSizeChange=size=>{pageSize.value=size,currentPage.value=1,filters.page=1,filters.limit=size,selectedIds.value=[],loadTaggingStatus()},handleRetryTagging=async fileIds=>{if(fileIds.length!==0)try{isProcessing.value=!0;const res=await retryTagging(fileIds);res.success&&(toast.success($t("admin.tagging.messages.retrySuccess").replace("{selected}",String(res.data?.requested??0)).replace("{enqueued}",String(res.data?.enqueued??0)).replace("{skipped}",String(res.data?.skipped??0))),await reloadData())}catch(e){toast.error(e?.message||$t("admin.tagging.messages.retryFailed"))}finally{isProcessing.value=!1}},handleResetStuck=async timeThreshold=>{try{isProcessing.value=!0;const result=await resetStuckTagging(timeThreshold);if(result.success){const{data}=result;data?.reset_count>0?toast.success($t("admin.tagging.messages.resetSuccess").replace("{count}",String(data.reset_count))):toast.info($t("admin.tagging.messages.resetEmpty")),await reloadData()}}catch(error){toast.error(error.message)}finally{isProcessing.value=!1}},handleRetryAllFailed=async()=>{try{isProcessing.value=!0;const res=await retryFailedAll(500);res.success&&(toast.success($t("admin.tagging.messages.retrySuccess").replace("{selected}",String(res.data?.selected??0)).replace("{enqueued}",String(res.data?.enqueued??0)).replace("{skipped}",String(res.data?.skipped??0))),await reloadData())}catch(error){toast.error(error.message)}finally{isProcessing.value=!1}},handleTriggerTagging=async()=>{try{isProcessing.value=!0;const res=await triggerTagging(200);if(res.success){const count=res.data?.submitted_count??0;count>0?toast.success($t("admin.tagging.messages.triggerSuccess").replace("{count}",String(count))):toast.info($t("admin.tagging.messages.triggerEmpty")),await reloadData()}}catch(error){toast.error(error.message)}finally{isProcessing.value=!1}},handleToggleSelect=id=>{const set=new Set(selectedIds.value);set.has(id)?set.delete(id):set.add(id),selectedIds.value=Array.from(set)},handleToggleSelectAll=checked=>{const pageIds=images.value.map(i=>i.id),set=new Set(selectedIds.value);checked?pageIds.forEach(id=>set.add(id)):pageIds.forEach(id=>set.delete(id)),selectedIds.value=Array.from(set)},handleIgnoreSelected=async(reason="")=>{if(selectedIds.value.length===0)return;const ids=selectedIds.value.slice(0,500);try{isProcessing.value=!0;const res=await ignoreTagging(ids,reason);res.success&&(toast.success($t("admin.tagging.messages.ignoreSuccess").replace("{count}",String(res.data?.count??ids.length))),selectedIds.value=[],await reloadData())}catch(e){toast.error(e?.message||$t("admin.tagging.messages.ignoreFailed"))}finally{isProcessing.value=!1}},handleUnignoreSelected=async()=>{if(selectedIds.value.length===0)return;const ids=selectedIds.value.slice(0,500);try{isProcessing.value=!0;const res=await unignoreTagging(ids);res.success&&(res.data?.enqueued!==void 0&&res.data?.skipped!==void 0?toast.success($t("admin.tagging.messages.unignoreSuccessDetail").replace("{count}",String(res.data?.count??ids.length)).replace("{enqueued}",String(res.data?.enqueued??0)).replace("{skipped}",String(res.data?.skipped??0))):toast.success($t("admin.tagging.messages.unignoreSuccess").replace("{count}",String(res.data?.count??ids.length))),selectedIds.value=[],await reloadData())}catch(e){toast.error(e?.message||$t("admin.tagging.messages.unignoreFailed"))}finally{isProcessing.value=!1}};return onMounted(async()=>{await Promise.all([reloadData(),loadAiSettings()]);try{const st=await getAutoProcessingStatus();if(st.success){autoEnabled.value=!!st.data?.enabled;const cfg=webSocketStore.queueStats?.runtime||webSocketStore.queueStats?.config;if(cfg){const v=cfg.configured_concurrency||cfg.max_concurrency;typeof v=="number"&&(concurrency.value=v)}}}catch{}}),onUnmounted(()=>{}),(_ctx,_cache)=>{const _component_CyberSwitch=resolveComponent("CyberSwitch"),_component_CyberSlider=resolveComponent("CyberSlider"),_component_CyberButton=resolveComponent("CyberButton"),_component_CyberAdminWrapper=resolveComponent("CyberAdminWrapper");return openBlock(),createElementBlock("div",_hoisted_1,[createVNode(_component_CyberAdminWrapper,{title:unref($t)("admin.tagging.title"),subtitle:unref($t)("admin.tagging.subtitle"),icon:"fas fa-tags"},{stats:withCtx(()=>[stats.value.length>0?(openBlock(),createElementBlock("span",_hoisted_2,toDisplayString(unref($t)("admin.tagging.stats.total").replace("{count}",String(stats.value.reduce((sum,item)=>sum+item.count,0)))),1)):createCommentVNode("",!0)]),actions:withCtx(()=>[createBaseVNode("div",_hoisted_3,[createBaseVNode("span",_hoisted_4,toDisplayString(unref($t)("admin.tagging.actions.autoProcessing")),1),createVNode(_component_CyberSwitch,{modelValue:autoEnabled.value,"onUpdate:modelValue":_cache[0]||(_cache[0]=$event=>autoEnabled.value=$event),disabled:updatingAuto.value,onChange:_cache[1]||(_cache[1]=async v=>{try{updatingAuto.value=!0,await unref(batchUpsertSettings)([{key:"ai_auto_processing_enabled",value:v,type:"boolean",group:"ai",description:unref($t)("admin.tagging.settingsDescriptions.autoProcessing")}]),await unref(setAutoProcessing)(v)}finally{updatingAuto.value=!1}})},null,8,["modelValue","disabled"])]),_cache[12]||(_cache[12]=createBaseVNode("div",{class:"bg-border-default mx-3 h-4 w-px"},null,-1)),createBaseVNode("div",_hoisted_5,[createBaseVNode("span",_hoisted_6,toDisplayString(unref($t)("admin.tagging.concurrency")),1),createVNode(_component_CyberSlider,{modelValue:concurrency.value,"onUpdate:modelValue":_cache[2]||(_cache[2]=$event=>concurrency.value=$event),min:1,max:30,step:1,class:"w-20",onChange:_cache[3]||(_cache[3]=async()=>{try{await unref(batchUpsertSettings)([{key:"ai_concurrency",value:concurrency.value,type:"number",group:"ai",description:unref($t)("admin.tagging.settingsDescriptions.concurrency")}]),await unref(setConcurrency)(concurrency.value)}catch{}})},null,8,["modelValue"]),createBaseVNode("span",_hoisted_7,toDisplayString(concurrency.value),1)]),_cache[13]||(_cache[13]=createBaseVNode("div",{class:"bg-border-default mx-3 h-4 w-px"},null,-1)),createVNode(_component_CyberButton,{type:"warning",class:"text-xs",disabled:isProcessing.value||!autoEnabled.value,onClick:_cache[4]||(_cache[4]=$event=>handleTriggerTagging())},{default:withCtx(()=>[_cache[8]||(_cache[8]=createBaseVNode("i",{class:"fas fa-wrench mr-1.5"},null,-1)),createTextVNode(toDisplayString(unref($t)("admin.tagging.buttons.fixQueue")),1)]),_:1},8,["disabled"]),createVNode(_component_CyberButton,{type:"primary",class:"ml-2 text-xs",disabled:isProcessing.value||!autoEnabled.value,onClick:_cache[5]||(_cache[5]=$event=>handleRetryAllFailed())},{default:withCtx(()=>[_cache[9]||(_cache[9]=createBaseVNode("i",{class:"fas fa-redo mr-1.5"},null,-1)),createTextVNode(toDisplayString(unref($t)("admin.tagging.buttons.retryFailed")),1)]),_:1},8,["disabled"]),createVNode(_component_CyberButton,{type:"secondary",class:"ml-2 text-xs",disabled:isProcessing.value,onClick:_cache[6]||(_cache[6]=$event=>handleResetStuck(60))},{default:withCtx(()=>[_cache[10]||(_cache[10]=createBaseVNode("i",{class:"fas fa-broom mr-1.5"},null,-1)),createTextVNode(toDisplayString(unref($t)("admin.tagging.buttons.resetStuck")),1)]),_:1},8,["disabled"]),createVNode(_component_CyberButton,{type:"outlined",class:normalizeClass(["ml-2 text-xs",{"border-brand-500 text-brand-500":showFilter.value}]),onClick:_cache[7]||(_cache[7]=$event=>showFilter.value=!showFilter.value)},{default:withCtx(()=>[_cache[11]||(_cache[11]=createBaseVNode("i",{class:"fas fa-filter mr-1.5"},null,-1)),createTextVNode(toDisplayString(unref($t)("admin.tagging.buttons.filter")),1)]),_:1},8,["class"])]),content:withCtx(()=>[createBaseVNode("div",_hoisted_8,[createBaseVNode("div",_hoisted_9,[createBaseVNode("div",_hoisted_10,[createBaseVNode("h3",_hoisted_11,[_cache[14]||(_cache[14]=createBaseVNode("i",{class:"fas fa-chart-bar mr-2"},null,-1)),createTextVNode(" "+toDisplayString(unref($t)("admin.tagging.queueStatus.title")),1)])]),createBaseVNode("div",_hoisted_12,[createVNode(TaggingQueueStatus,{"selected-status":filters.status,onSelect:handleStatusSelect},null,8,["selected-status"])])]),showFilter.value?(openBlock(),createElementBlock("div",_hoisted_13,[createVNode(Transition,{name:"filter-panel","enter-active-class":"transition duration-300 ease-out","leave-active-class":"transition duration-200 ease-in","enter-from-class":"opacity-0 transform -translate-y-8","enter-to-class":"opacity-100 transform translate-y-0","leave-from-class":"opacity-100 transform translate-y-0","leave-to-class":"opacity-0 transform -translate-y-8"},{default:withCtx(()=>[createVNode(TaggingFilterPanel,{"initial-filters":filters,onFilter:handleFilter},null,8,["initial-filters"])]),_:1})])):createCommentVNode("",!0),createBaseVNode("div",_hoisted_14,[createVNode(TaggingFileList,{images:images.value,"is-loading":showSkeleton.value||isLoading.value,total:total.value,"current-page":currentPage.value,"page-size":pageSize.value,processing:isProcessing.value,"selected-ids":selectedIds.value,onRetry:handleRetryTagging,onPageChange:handlePageChange,onPageSizeChange:handlePageSizeChange,onToggleSelect:handleToggleSelect,onToggleSelectAll:handleToggleSelectAll,onIgnoreSelected:handleIgnoreSelected,onUnignoreSelected:handleUnignoreSelected},null,8,["images","is-loading","total","current-page","page-size","processing","selected-ids"])]),createBaseVNode("div",_hoisted_15,[createBaseVNode("div",_hoisted_16,[createBaseVNode("h3",_hoisted_17,[_cache[15]||(_cache[15]=createBaseVNode("i",{class:"fas fa-history mr-2"},null,-1)),createTextVNode(" "+toDisplayString(unref($t)("admin.tagging.recentLogs.title")),1)])]),createBaseVNode("div",_hoisted_18,[createVNode(TaggingLogList,{logs:logs.value,pagination:logPagination.value,"selected-file-id":selectedFileId.value,onLoadMore:handleLogLoadMore,onRefresh:handleLogRefresh,onClearFilter:handleClearLogFilter},null,8,["logs","pagination","selected-file-id"])])])])]),_:1},8,["title","subtitle"])])}}});const index=_export_sfc(_sfc_main,[["__scopeId","data-v-565b040c"]]);export{index as default};
