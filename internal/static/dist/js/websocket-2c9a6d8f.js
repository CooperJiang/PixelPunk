import{Y as defineStore,r as ref,c as computed,Z as readonly}from"./vue-vendor-31320f47.js";import{j as useTexts,n as useAuthStore}from"./index-4d0dab4c.js";import"./editor-markdown-0b2e1ce5.js";var __defProp=Object.defineProperty,__defNormalProp=(obj,key,value)=>key in obj?__defProp(obj,key,{enumerable:!0,configurable:!0,writable:!0,value}):obj[key]=value,__publicField=(obj,key,value)=>(__defNormalProp(obj,typeof key!="symbol"?key+"":key,value),value),MessageType=(MessageType2=>(MessageType2.QUEUE_STATS="queue_stats",MessageType2.VECTOR_STATS="vector_stats",MessageType2.LOGS="logs",MessageType2.ANNOUNCEMENT="announcement",MessageType2.SYSTEM_STATUS="system_status",MessageType2.ERROR="error",MessageType2.PING="ping",MessageType2.PONG="pong",MessageType2))(MessageType||{}),ConnectionStatus=(ConnectionStatus2=>(ConnectionStatus2.CONNECTING="connecting",ConnectionStatus2.CONNECTED="connected",ConnectionStatus2.DISCONNECTED="disconnected",ConnectionStatus2.RECONNECTING="reconnecting",ConnectionStatus2.ERROR="error",ConnectionStatus2))(ConnectionStatus||{});class WebSocketManager{constructor(options){__publicField(this,"ws",null),__publicField(this,"options"),__publicField(this,"status","disconnected"),__publicField(this,"reconnectAttempts",0),__publicField(this,"reconnectTimeout",null),__publicField(this,"pingInterval",null),__publicField(this,"messageHandlers",new Map),__publicField(this,"statusChangeHandlers",[]),__publicField(this,"errorHandlers",[]),this.options={reconnectDelay:5e3,maxReconnectAttempts:5,pingInterval:3e4,debug:!1,...options},Object.values(MessageType).forEach(type=>{this.messageHandlers.set(type,[])})}connect(){if(this.ws&&this.ws.readyState===WebSocket.OPEN){this.log("WebSocket already connected");return}this.setStatus("connecting");try{const wsUrl=this.buildWebSocketUrl();this.log(`Connecting to WebSocket: ${wsUrl}`),this.ws=new WebSocket(wsUrl),this.setupEventListeners()}catch(error){this.handleError(new Error(`Failed to create WebSocket connection: ${error}`))}}disconnect(){this.log("Disconnecting WebSocket"),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.ws&&(this.ws.close(1e3,"Manual disconnect"),this.ws=null),this.setStatus("disconnected"),this.reconnectAttempts=0}send(message){if(!this.ws||this.ws.readyState!==WebSocket.OPEN){this.log("WebSocket not connected, cannot send message");return}const fullMessage={id:this.generateMessageId(),type:"ping",priority:"normal",timestamp:Date.now(),...message};try{this.ws.send(JSON.stringify(fullMessage)),this.log("Message sent:",fullMessage)}catch(error){this.handleError(new Error(`Failed to send message: ${error}`))}}on(type,handler){const handlers=this.messageHandlers.get(type)||[];handlers.push(handler),this.messageHandlers.set(type,handlers)}off(type,handler){const handlers=this.messageHandlers.get(type)||[],index=handlers.indexOf(handler);index>-1&&(handlers.splice(index,1),this.messageHandlers.set(type,handlers))}onStatusChange(handler){return this.statusChangeHandlers.push(handler),()=>{const index=this.statusChangeHandlers.indexOf(handler);index>-1&&this.statusChangeHandlers.splice(index,1)}}onError(handler){return this.errorHandlers.push(handler),()=>{const index=this.errorHandlers.indexOf(handler);index>-1&&this.errorHandlers.splice(index,1)}}getStatus(){return this.status}isConnected(){return this.status==="connected"&&this.ws?.readyState===WebSocket.OPEN}subscribeQueueStats(handler){const messageHandler=message=>{handler(message.data)};return this.on("queue_stats",messageHandler),()=>{this.off("queue_stats",messageHandler)}}subscribeVectorStats(handler){const messageHandler=message=>{handler(message.data)};return this.on("vector_stats",messageHandler),()=>{this.off("vector_stats",messageHandler)}}subscribeAnnouncement(handler){const messageHandler=message=>{handler(message.data)};return this.on("announcement",messageHandler),()=>{this.off("announcement",messageHandler)}}subscribeLogs(handler){const messageHandler=message=>{handler(message.data)};return this.on("logs",messageHandler),()=>{this.off("logs",messageHandler)}}buildWebSocketUrl(){const{url,token}=this.options,wsUrl=url.replace(/^http/,"ws");if(token){const separator=wsUrl.includes("?")?"&":"?";return`${wsUrl}${separator}token=${token}`}return wsUrl}setupEventListeners(){this.ws&&(this.ws.onopen=()=>{this.log("WebSocket connected"),this.setStatus("connected"),this.reconnectAttempts=0,this.startPing()},this.ws.onmessage=event=>{try{const message=JSON.parse(event.data);this.handleMessage(message)}catch(error){this.handleError(new Error(`Failed to parse message: ${error}`))}},this.ws.onclose=event=>{this.log(`WebSocket closed: ${event.code} - ${event.reason}`),this.setStatus("disconnected"),this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),event.code!==1e3&&this.reconnectAttempts<this.options.maxReconnectAttempts&&this.scheduleReconnect()},this.ws.onerror=error=>{this.log("WebSocket error:",error),this.handleError(new Error("WebSocket connection error"))})}handleMessage(message){if(this.log("Message received:",message),message.type==="pong"){this.log("Received pong from server");return}(this.messageHandlers.get(message.type)||[]).forEach(handler=>{try{handler(message)}catch(error){this.log("Error in message handler:",error)}})}setStatus(status){this.status!==status&&(this.status=status,this.log(`Status changed to: ${status}`),this.statusChangeHandlers.forEach(handler=>{try{handler(status)}catch(error){this.log("Error in status change handler:",error)}}))}handleError(_error){this.log("Error:",_error.message),this.setStatus("error"),this.errorHandlers.forEach(handler=>{try{handler(_error)}catch(err){this.log("Error in error handler:",err)}})}scheduleReconnect(){this.reconnectAttempts++,this.setStatus("reconnecting");const delay=this.options.reconnectDelay*this.reconnectAttempts;this.log(`Scheduling reconnect attempt ${this.reconnectAttempts} in ${delay}ms`),this.reconnectTimeout=window.setTimeout(()=>{this.connect()},delay)}startPing(){this.pingInterval&&clearInterval(this.pingInterval),this.pingInterval=window.setInterval(()=>{this.isConnected()&&this.send({type:"ping",data:{timestamp:Date.now()}})},this.options.pingInterval)}generateMessageId(){return`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}log(...args){this.options.debug}}let globalWebSocketManager=null;function getWebSocketURL(){const protocol=window.location.protocol==="https:"?"wss:":"ws:";let host;return host=window.location.host,`${protocol}//${host}/api/v1/admin/ws/admin`}function getWebSocketManager(token){if(!globalWebSocketManager){const url=getWebSocketURL();globalWebSocketManager=new WebSocketManager({url,token,debug:!1})}return globalWebSocketManager}function destroyWebSocketManager(){globalWebSocketManager&&(globalWebSocketManager.disconnect(),globalWebSocketManager=null)}const useWebSocketStore=defineStore("websocket",()=>{const{$t}=useTexts(),isConnected=ref(!1),connectionStatus=ref(ConnectionStatus.DISCONNECTED),lastError=ref(null),lastUpdated=ref(new Date),queueStats=ref(null),vectorStats=ref(null),announcements=ref([]),systemLogs=ref([]);let wsManager=null,unsubscribeFunctions=[];const connectionStatusText=computed(()=>{switch(connectionStatus.value){case ConnectionStatus.CONNECTED:return $t("store.websocket.status.connected");case ConnectionStatus.CONNECTING:return $t("store.websocket.status.connecting");case ConnectionStatus.RECONNECTING:return $t("store.websocket.status.reconnecting");case ConnectionStatus.DISCONNECTED:return $t("store.websocket.status.disconnected");case ConnectionStatus.ERROR:return $t("store.websocket.status.error");default:return $t("store.websocket.status.unknown")}}),lastUpdatedText=computed(()=>{const diff=new Date().getTime()-lastUpdated.value.getTime(),seconds=Math.floor(diff/1e3);if(seconds<60)return $t("store.websocket.lastUpdated.seconds",{seconds:String(seconds)});const minutes=Math.floor(seconds/60);return $t("store.websocket.lastUpdated.minutes",{minutes:String(minutes)})}),queueCompletionRate=computed(()=>!queueStats.value||queueStats.value.queue_stats.total_count===0?0:Math.round(queueStats.value.queue_stats.done_count/queueStats.value.queue_stats.total_count*100)),initWebSocket=()=>{const authStore=useAuthStore();if(authStore.isAdmin&&!wsManager)try{wsManager=getWebSocketManager(authStore.token||void 0);const statusUnsubscribe=wsManager.onStatusChange(status=>{connectionStatus.value=status,isConnected.value=status===ConnectionStatus.CONNECTED}),errorUnsubscribe=wsManager.onError(error=>{lastError.value=error}),queueUnsubscribe=wsManager.subscribeQueueStats(data=>{queueStats.value=data,lastUpdated.value=new Date}),vectorUnsubscribe=wsManager.subscribeVectorStats(data=>{vectorStats.value=data,lastUpdated.value=new Date}),announcementUnsubscribe=wsManager.subscribeAnnouncement(data=>{announcements.value.unshift(data),announcements.value.length>50&&(announcements.value=announcements.value.slice(0,50))}),logsUnsubscribe=wsManager.subscribeLogs(data=>{systemLogs.value.unshift(data),systemLogs.value.length>100&&(systemLogs.value=systemLogs.value.slice(0,100))});unsubscribeFunctions=[statusUnsubscribe,errorUnsubscribe,queueUnsubscribe,vectorUnsubscribe,announcementUnsubscribe,logsUnsubscribe],wsManager.connect()}catch(error){lastError.value=error}},disconnectWebSocket=()=>{wsManager&&(unsubscribeFunctions.forEach(unsubscribe=>unsubscribe()),unsubscribeFunctions=[],wsManager.disconnect(),wsManager=null),isConnected.value=!1,connectionStatus.value=ConnectionStatus.DISCONNECTED,lastError.value=null},destroyWebSocket=()=>{disconnectWebSocket(),destroyWebSocketManager(),queueStats.value=null,vectorStats.value=null,announcements.value=[],systemLogs.value=[]},reconnectWebSocket=()=>{disconnectWebSocket(),setTimeout(()=>{initWebSocket()},1e3)},sendMessage=message=>{wsManager&&isConnected.value&&wsManager.send(message)};return{isConnected:readonly(isConnected),connectionStatus:readonly(connectionStatus),connectionStatusText,lastError:readonly(lastError),lastUpdated:readonly(lastUpdated),lastUpdatedText,queueStats:readonly(queueStats),vectorStats:readonly(vectorStats),announcements:readonly(announcements),systemLogs:readonly(systemLogs),queueCompletionRate,initWebSocket,disconnectWebSocket,destroyWebSocket,reconnectWebSocket,sendMessage}});export{useWebSocketStore as u};
